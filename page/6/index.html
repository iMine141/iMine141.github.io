<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="iMine"><meta name="copyright" content="iMine"><title>iMineのBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 7.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">iMine</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">74</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">9</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">24</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">iMineのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">iMineのBlog</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/26/Effective%20java/%E7%B1%BB%E5%92%8C%E6%8E%A5%E5%8F%A3/">类和接口</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/">java</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/effective-java/">effective java</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/effectivejava/">effectivejava</a></span><div class="content"><h3 id="第-15-条：使类和成员的可访问性最小化"><a href="#第-15-条：使类和成员的可访问性最小化" class="headerlink" title="第 15 条：使类和成员的可访问性最小化"></a>第 15 条：使类和成员的可访问性最小化</h3><p>公有静态 final 域暴露常量，要么包含基本类型值，要么包含指向不可变对象的引用</p>
<h3 id="第-16-条：在公有类中使用访问方法而非公有域"><a href="#第-16-条：在公有类中使用访问方法而非公有域" class="headerlink" title="第 16 条：在公有类中使用访问方法而非公有域"></a>第 16 条：在公有类中使用访问方法而非公有域</h3><ul>
<li>公有类不应该暴露可变域，因为其客户端代码遍布各处，将来极难改变内部表示法</li>
<li>公有类暴露不可变域危害较小，事实上也不应该</li>
<li>包级私有或私有嵌套类，直接暴露数据域并没有本质错误</li>
</ul>
<h3 id="第-17-条：使可变性最小化"><a href="#第-17-条：使可变性最小化" class="headerlink" title="第 17 条：使可变性最小化"></a>第 17 条：使可变性最小化</h3><p>如果类不能被做成不可变，仍然应该尽可能限制它的可变性，降低对象可以存在的状态数！构造器应该创建完全初始化的对象，并建立所有的约束关系，不要在构造器或静态工厂之外再提供公有的初始化方法，除非有足够的理由！</p>
<h3 id="第-18-条：复合优先于继承"><a href="#第-18-条：复合优先于继承" class="headerlink" title="第 18 条：复合优先于继承"></a>第 18 条：复合优先于继承</h3><p>在包内部使用继承是安全的，跨越包边界的继承是危险的</p>
<h3 id="第-19-条：要么为继承而设计，并提供文档说明，要么就禁止继承"><a href="#第-19-条：要么为继承而设计，并提供文档说明，要么就禁止继承" class="headerlink" title="第 19 条：要么为继承而设计，并提供文档说明，要么就禁止继承"></a>第 19 条：要么为继承而设计，并提供文档说明，要么就禁止继承</h3><p>对于专门为继承而设计且有良好文档说明的类</p>
<ul>
<li>该类文档必须有文档说明它可覆盖方法的自用性</li>
<li>该类必须通过某种形式提供适当的钩子，以便能进入它的内部工作流程中</li>
<li>构造器，clone 或者 readObject 绝不能调用可被覆盖的方法，不管是直接还是间接</li>
</ul>
<p>并非为了安全进行子类化而设计和编写文档的类，要禁止子类化</p>
<ul>
<li>将类声明为 final</li>
<li>将构造器变成 private 或 package-private，并增加一些公有的静态工厂来替代构造器</li>
</ul>
<h3 id="第-20-条：接口优于抽象类"><a href="#第-20-条：接口优于抽象类" class="headerlink" title="第 20 条：接口优于抽象类"></a>第 20 条：接口优于抽象类</h3><p>接口与抽象类的区别</p>
<ul>
<li>抽象类允许包含某些方法的实现，接口不允许</li>
<li>为实现抽象类定义类型，类必须成为抽象类的子类，而接口则不用关心类层次</li>
<li>现有类容易被更新以实现新接口，一般无法更新现有类来扩展新抽象类</li>
<li>接口是定义 mixin 的理想选择，mixin 用来表明类提供了某些可供选择的行为，允许任选功能混合到类型主要功能中</li>
<li>接口允许构造非层次结构的类型框架</li>
</ul>
<h3 id="第-21-条-为子类设计接口"><a href="#第-21-条-为子类设计接口" class="headerlink" title="第 21 条: 为子类设计接口"></a>第 21 条: 为子类设计接口</h3><p>编写一个默认方法并不总是可能的，它保留了每个可能的实现的所有不变量。</p>
<p>在默认方法的情况下，接口的现有实现类可以在没有错误或警告的情况下编译，但在运行时会失败。</p>
<h3 id="第-22-条：接口只用于定义类型"><a href="#第-22-条：接口只用于定义类型" class="headerlink" title="第 22 条：接口只用于定义类型"></a>第 22 条：接口只用于定义类型</h3><p>常量接口模式是对接口的不良使用，是反面典型，不值得效仿！</p>
<p>关键原因：如果类实现常量接口，将来版本中类修改了，不需要这些常量了，它还依然必须实现这个接口，以确保二进制兼容性！</p>
<h3 id="第-23-条：类层次优于标签类"><a href="#第-23-条：类层次优于标签类" class="headerlink" title="第 23 条：类层次优于标签类"></a>第 23 条：类层次优于标签类</h3><p>类层次！首先，定义一个抽象类作为根类，提取公用方法到抽象类中！然后，为每种原始标签类定义根类的具体子类，子类包含特定域和方法！</p>
<h3 id="第-24-条：优先考虑静态成员类，而不是非静态类"><a href="#第-24-条：优先考虑静态成员类，而不是非静态类" class="headerlink" title="第 24 条：优先考虑静态成员类，而不是非静态类"></a>第 24 条：优先考虑静态成员类，而不是非静态类</h3><h3 id="第-25-条-将源文件限制为单个顶级类"><a href="#第-25-条-将源文件限制为单个顶级类" class="headerlink" title="第 25 条: 将源文件限制为单个顶级类"></a>第 25 条: 将源文件限制为单个顶级类</h3><p>虽然 Java 编译器允许在单个源文件中定义多个顶级类，但这样做没有任何好处，并且存在重大风险。 风险源于在源文件中定义多个顶级类使得为类提供多个定义成为可能。 使用哪个定义会受到源文件传递给编译器的顺序的影响。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/25/Effective%20java/%E5%AF%B9%E4%BA%8E%E6%89%80%E6%9C%89%E5%AF%B9%E8%B1%A1%E9%83%BD%E9%80%9A%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95/">对所有对象都通用的方法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/">java</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/effective-java/">effective java</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/effectivejava/">effectivejava</a></span><div class="content"><h3 id="第-10-条：覆盖-equals-时请遵守通用约定"><a href="#第-10-条：覆盖-equals-时请遵守通用约定" class="headerlink" title="第 10 条：覆盖 equals 时请遵守通用约定"></a>第 10 条：覆盖 equals 时请遵守通用约定</h3><ul>
<li>自反性 - 对象必须等于其自身</li>
<li>对称性 - 任何两个对象对于它们是否相等的问题都必须保持一致，Timestamp 违反了，不值得效仿</li>
<li>传递性 - 如果对象 A 等于B，B 等于 C，那么 A 一定等于 C</li>
<li>一致性 - 相等的对象永远相等，不相等的对象永远不相等</li>
<li>非空性 - 所有的对象都必须不等于 null</li>
</ul>
<h3 id="第-11-条：覆盖-equals-时总要覆盖-hashCode"><a href="#第-11-条：覆盖-equals-时总要覆盖-hashCode" class="headerlink" title="第 11 条：覆盖 equals 时总要覆盖 hashCode"></a>第 11 条：覆盖 equals 时总要覆盖 hashCode</h3><ul>
<li>程序一次执行期间，只要对象的 equals 比较用到的信息没有被修改，则对该对象调用多次 hashCode 都必须返回同一值</li>
<li>程序多次执行过程，每次执行返回的 hashCode 可以不一致</li>
<li>相等的对象必须有相等的散列码</li>
<li>不相等的对象不一定要产生不同的散列码，但是通常倾向于为不相等对象产生不相等的散列码</li>
</ul>
<p>注意，如果一个类是不可变的，同时计算散列码开销也大，则可把散列码缓存在对象内部！不要试图从散列码计算中排除掉一个对象的关键部分来提高性能！</p>
<h3 id="第-12-条：始终要覆盖toString"><a href="#第-12-条：始终要覆盖toString" class="headerlink" title="第 12 条：始终要覆盖toString"></a>第 12 条：始终要覆盖toString</h3><p>java.lang.Object 提供了 toString 方法的一个实现：类名 + ‘@’ + 散列码无符号 16 进制表示！</p>
<p>无论是否指定格式，都为 toString 返回值中包含的所有信息提供一种编程式的访问途径！如果没有，则会迫使程序员编写额外代码解析字符串，既降低性能，又容易解析出错导致系统不稳定！</p>
<h3 id="第-13-条：谨慎地覆盖-clone"><a href="#第-13-条：谨慎地覆盖-clone" class="headerlink" title="第 13 条：谨慎地覆盖 clone"></a>第 13 条：谨慎地覆盖 clone</h3><p>Object 的 clone 方法是受保护的！Cloneable 接口没有包含任何方法！Cloneable 改变了超类中受保护的方法的行为！对于实现了 Cloneable 的类，我们总是希望它提供一个功能适当的公有的 clone 方法！此方法首先调用 super.clone，然后修正任何需要修正的域！</p>
<p>实现对象拷贝更好的办法</p>
<ul>
<li>拷贝构造器 - 唯一参数类型是包含该构造器的类，<code>public Yum(Yum yum);</code></li>
<li>拷贝工厂 - <code>public static Yum newInstance(Yum yum);</code></li>
</ul>
<h3 id="第-14-条：考虑实现-Comparable-接口"><a href="#第-14-条：考虑实现-Comparable-接口" class="headerlink" title="第 14 条：考虑实现 Comparable 接口"></a>第 14 条：考虑实现 Comparable 接口</h3><p>包含 compareTo 方法的对象与指定对象比较，当该对象小于、等于或者大于指定对象时，分别返回一个负整数、零或者正整数！compareTo 要满足自反性、对称性和传递性！</p>
<p>注意，比较整数基本类型域可使用关系操作符&lt;和&gt;，浮点域可使用 Double.compare 或者 Float.compare！</p>
<p>通常在 compareTo 中为了简化代码，会以两数作差表示比较大小的结果，这种方法有风险！记住！一个有符号的 32 位的整数还没有大到足以表达任意两个32位整数的差！如一个很大的正整数减去一个很大负整数将会溢出，并返回一个负值，导致错误结果！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/24/Effective%20java/%E5%88%9B%E5%BB%BA%E5%92%8C%E9%94%80%E6%AF%81%E5%AF%B9%E8%B1%A1/">创建和销毁对象</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-24</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/">java</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/effective-java/">effective java</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/effectivejava/">effectivejava</a></span><div class="content"><h3 id="第-1-条-：-考虑使用静态工厂方法替代构造方法"><a href="#第-1-条-：-考虑使用静态工厂方法替代构造方法" class="headerlink" title="第 1 条 ： 考虑使用静态工厂方法替代构造方法"></a>第 1 条 ： 考虑使用静态工厂方法替代构造方法</h3><p>静态工厂方法实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title function_">valueOf</span><span class="params">(<span class="type">boolean</span> b)</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> b ? Boolean.TRUE : Boolean.FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>静态工厂方法的优点：</p>
<ul>
<li>有方法名，比构造方法更加容易理解</li>
<li>不用重复创建新对象</li>
<li>可以返回子类型</li>
<li>返回对象的类可以根据输入参数的不同而不同</li>
<li>静态方法更适于做服务型接口</li>
</ul>
<p>静态工厂方法的缺点：</p>
<ul>
<li>可能无法被子类实例化（私有的构造器）</li>
<li>不利于检索（比较难找到对应代码）</li>
</ul>
<h3 id="第2条：当构造方法参数过多时使用-builder-模式"><a href="#第2条：当构造方法参数过多时使用-builder-模式" class="headerlink" title="第2条：当构造方法参数过多时使用 builder 模式"></a>第2条：当构造方法参数过多时使用 builder 模式</h3><p>可选参数比较多时，可用下面几种方法</p>
<ol>
<li>可伸缩构造方法模式，但是当有很多参数时，很难编写，并读懂它。</li>
<li>使用javaBean模式，通过setter方法设置参数，但构造变得困难，而且变得不安全</li>
<li>Builder模式，不直接生成对象，而是先得到builder对象，通过builder的类似setter方法设置参数，最后调用build方法生成不可变对象</li>
</ol>
<p>缺点：Builder 模式比重叠构造器更冗长，只在参数很多的时候才使用，比如四个或者更多。</p>
<p>Builder方法实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Builder Pattern </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NutritionFacts</span> &#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> servingSize; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> servings; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> calories; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> fat; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> sodium; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> carbohydrate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123; </span><br><span class="line">        <span class="comment">// Required parameters </span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> servingSize; </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> servings;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Optional parameters - initialized to default values </span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> calories </span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> fat</span><br><span class="line">	    <span class="keyword">private</span> <span class="type">int</span> sodium= <span class="number">0</span>; = <span class="number">0</span>; = <span class="number">0</span>;</span><br><span class="line">	    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">carbohydrate</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">		<span class="keyword">public</span> <span class="title function_">Builder</span><span class="params">(<span class="type">int</span> servingSize, <span class="type">int</span> servings)</span> &#123; </span><br><span class="line">            <span class="built_in">this</span>.servingSize = servingSize; </span><br><span class="line">            <span class="built_in">this</span>.servings = servings; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">calories</span><span class="params">(<span class="type">int</span> val)</span> &#123; </span><br><span class="line">            calories = val; </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">fat</span><span class="params">(<span class="type">int</span> val)</span> &#123; </span><br><span class="line">            fat = val; </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">sodium</span><span class="params">(<span class="type">int</span> val)</span> &#123; </span><br><span class="line">            sodium = val;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">carbohydrate</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">            carbohydrate = val; <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> NutritionFacts <span class="title function_">build</span><span class="params">()</span> &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NutritionFacts</span>(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">NutritionFacts</span><span class="params">(Builder builder)</span> &#123; </span><br><span class="line">        servingSize = builder.servingSize; </span><br><span class="line">        servings = builder.servings;</span><br><span class="line">        calories = builder.calories;</span><br><span class="line">        fat = builder.fat;</span><br><span class="line">        sodium = builder.sodium;</span><br><span class="line">        carbohydrate = builder.carbohydrate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>



<h3 id="第3条：使用私有构造方法或枚举类实现-Singleton-属-性"><a href="#第3条：使用私有构造方法或枚举类实现-Singleton-属-性" class="headerlink" title="第3条：使用私有构造方法或枚举类实现 Singleton 属 性"></a>第3条：使用私有构造方法或枚举类实现 Singleton 属 性</h3><p>Java 1.5 之前，实现单例是通过“构造器私有化，静态公有 final 实例对象”，或直接获取，或通过方法获取。</p>
<p>Java 1.5 之后，实现单例的最佳方法，是编写“单元素的枚举”类型：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Elvis</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whateverMethod</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无偿提供序列化，防止多次实例化。</p>
<h3 id="第4条：使用私有构造器执行非实例化"><a href="#第4条：使用私有构造器执行非实例化" class="headerlink" title="第4条：使用私有构造器执行非实例化"></a>第4条：使用私有构造器执行非实例化</h3><p>一些工具类不希望被实例化，将构造函数私有，避免外部调用，并在构造函数中抛异常，避免内部调用。</p>
<h3 id="第5条：依赖注入优于硬连接资源（hardwiring-resources）"><a href="#第5条：依赖注入优于硬连接资源（hardwiring-resources）" class="headerlink" title="第5条：依赖注入优于硬连接资源（hardwiring resources）"></a>第5条：依赖注入优于硬连接资源（hardwiring resources）</h3><p>行为参数化是依赖注入的有用变体，将<code>Lexicon dictionary</code>作为参数，相对硬编码更加灵活。</p>
<p>对于行为参数化的类，可以通过策略模式和lambda表达式灵活实现</p>
<h3 id="第6条：避免创建不必要的对象"><a href="#第6条：避免创建不必要的对象" class="headerlink" title="第6条：避免创建不必要的对象"></a>第6条：避免创建不必要的对象</h3><p>最好能重用对象而不是在每次需要的时候就创建一个相同功能的新对象。如果对象是不可变的，它就始终可以被重用。</p>
<p>优先使用基本类型而不是装箱基本类型，当心无意识的自动装箱，比如：下面这个程序会有大量装箱成Long</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>；</span><br><span class="line"><span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= Integer.MAX_VALUE; i++)</span><br><span class="line">	sum += i;</span><br></pre></td></tr></table></figure>

<p>使用 Byte.valueOf 来创建包装类型，因为 -128~127 的数会缓存起来，要从缓冲池中取，Short、Integer、Long 也是这样。 </p>
<h3 id="第-7-条：消除过期的对象引用"><a href="#第-7-条：消除过期的对象引用" class="headerlink" title="第 7 条：消除过期的对象引用"></a>第 7 条：消除过期的对象引用</h3><p>不需要对所有对象显式置空，以下情形考虑资源手工处理：</p>
<ul>
<li>类是自己管理内存，如例子中的 Stack 类。</li>
<li>使用对象缓存机制时，需要考虑被从缓存中换出的对象，或是长期不会被访问到的对象。</li>
<li>事件监听器和相关回调。使用弱引用</li>
</ul>
<h3 id="第-8-条：避免使用终结方法"><a href="#第-8-条：避免使用终结方法" class="headerlink" title="第 8 条：避免使用终结方法"></a>第 8 条：避免使用终结方法</h3><p>finalizer 不保证会被及时的执行，甚至不一定执行。</p>
<p>除非是作为安全网，或者为终止非关键的本地资源，否则请不要使用终结方法。</p>
<h3 id="第-9-条-用-try-with-resources-代替-try-finally"><a href="#第-9-条-用-try-with-resources-代替-try-finally" class="headerlink" title="第 9 条: 用 try-with-resources 代替 try-finally"></a>第 9 条: 用 try-with-resources 代替 try-finally</h3><p>实现 AutoCloseable 接口的类应使用 try-with-resources，因其可同时处理多个资源，不用嵌套</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/22/Spring/Web/Spring%20MVC/">Spring MVC</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-22</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/">spring</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/Web/">Web</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/spring/">spring</a></span><div class="content"><h3 id="1-Spring-MVC-概览"><a href="#1-Spring-MVC-概览" class="headerlink" title="1 Spring MVC 概览"></a>1 Spring MVC 概览</h3><p>Spring 提供了一个功能齐全的 MVC 框架用于构建 Web 应用程序。Spring 框架可以很容易的和其他的 MVC 框架融合(如 Struts)，该框架使用控制反转(IOC)将控制器逻辑和业务对象分离开来。它也允许以声明的方式绑定请求参数到业务对象上。</p>
<ul>
<li>DispatcherServlet<ul>
<li>Spring 的 MVC 框架是围绕 DispatcherServlet 来设计的，它用来处理所有的 HTTP 请求和响应。</li>
</ul>
</li>
<li>WebApplicationContext<ul>
<li>WebApplicationContext 继承了 ApplicationContext，并添加了一些 web 应用程序需要的功能。和普通的 ApplicationContext 不同，WebApplicationContext 可以用来处理主题样式，它也知道如何找到相应的 servlet。</li>
</ul>
</li>
<li>Controller<ul>
<li>控制器提供对应用程序行为的访问，通常通过服务接口实现。控制器解析用户的输入，并将其转换为一个由视图呈现给用户的模型。Spring 通过一种极其抽象的方式实现控制器，它允许用户创建多种类型的控制器。</li>
<li>@Controller 注解表示该类扮演控制器的角色。Spring 不需要继承任何控制器基类或应用 Servlet API。</li>
</ul>
</li>
<li>@RequestMapping 注解用于将 URL 映射到任何一个类或者一个特定的处理方法上。</li>
</ul>
<h4 id="1-1-Spring-MVC-运行原理"><a href="#1-1-Spring-MVC-运行原理" class="headerlink" title="1.1 Spring MVC 运行原理"></a>1.1 Spring MVC 运行原理</h4><p><img src="https://imine141.github.io/images/1545011851570.png" alt="img"></p>
<ol>
<li>Spring MVC 通过一个单独的前端控制器（DispatcherServlet）过滤分发请求。</li>
<li>DispatcherServlet 根据处理器映射（HandlerMapping）和请求携带的 URL 决定将请求发送给某个控制器（Controller）。</li>
<li>控制器从请求中取得信息，然后委托业务逻辑组件处理。将处理结果打包在模型（model）中，然后指定一个视图（view）的逻辑名称，然后将请求和模型、视图名称一起发送回 DispatcherServlet。</li>
<li>DispatcherServlet 用视图名称查找对应的视图解析器（ViewResolver），负责将逻辑名称转换成对应的页面实现。</li>
<li>最后一步就是视图的实现。视图会使用模型数据填充到视图实现中，然后将结果放在 HTTP 响应对象中。</li>
</ol>
<h4 id="1-2-Spring-MVC-配置"><a href="#1-2-Spring-MVC-配置" class="headerlink" title="1.2 Spring MVC 配置"></a>1.2 Spring MVC 配置</h4><h5 id="1）配置前端控制器"><a href="#1）配置前端控制器" class="headerlink" title="1）配置前端控制器"></a>1）配置前端控制器</h5><p>继承了 AbstractAnnotationConfigDispatcherServletInitializer，会在项目运行初始化被自动发现并加载。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span> &#123;</span><br><span class="line">       <span class="comment">// 根容器</span></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123; </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123; RootConfig.class &#125;;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Spring mvc 容器，指定配置类</span></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123; </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123; WebConfig.class &#125;;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// DispatcherServlet 映射,从&quot;/&quot;开始</span></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">protected</span> String[] getServletMappings() &#123; </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;/&quot;</span> &#125;;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AppInitializer 类需要实现三个方法，RootConfig 和 WebConfig 是两个关键配置类，而 getServletMappings 只需要返回一个 String 的列表，{“&#x2F;”}的意思是监听访问 url 下所有的请求。</p>
<h5 id="2）配置视图解析器"><a href="#2）配置视图解析器" class="headerlink" title="2）配置视图解析器"></a>2）配置视图解析器</h5><p>@EnableWebMvc：启动 Spring MVC 特性<br>configer.enable()：静态资源的请求将转交给 servlert 容器的 default servlet 处理。</p>
<ul>
<li>setPrefix() 方法用于设置视图路径的前缀；</li>
<li>setSuffix() 用于设置视图路径的后缀；</li>
<li>setExposeContextBeansAsAttributes(true) 使得可以在 JSP 页面中通过 ${ } 访问容器中的 bean</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span><span class="comment">//启动Spring MVC</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;org.test.spittr.web&quot;)</span><span class="comment">//启动组件扫描</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> &#123;</span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">       <span class="keyword">public</span> ViewResolver <span class="title function_">viewResolver</span><span class="params">()</span> &#123; </span><br><span class="line">             <span class="comment">// 配置JSP视图解析器</span></span><br><span class="line">             <span class="type">InternalResourceViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternalResourceViewResolver</span>();</span><br><span class="line">             resolver.setPrefix(<span class="string">&quot;/WEB-INF/views/&quot;</span>);</span><br><span class="line">             resolver.setSuffix(<span class="string">&quot;.jsp&quot;</span>);</span><br><span class="line">             <span class="comment">// 可以在JSP页面中通过$&#123;&#125;访问beans</span></span><br><span class="line">             resolver.setExposeContextBeansAsAttributes(<span class="literal">true</span>);</span><br><span class="line">             <span class="keyword">return</span> resolver;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> &#123;</span><br><span class="line">        configurer.enable(); <span class="comment">//配置静态文件处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3）配置-Bean"><a href="#3）配置-Bean" class="headerlink" title="3）配置 Bean"></a>3）配置 Bean</h5><p>RootConfig 在设置扫描机制的时候，将之前 WebConfig 设置过的那个包排除了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123; &quot;org.test.spittr.controller&quot; &#125;, excludeFilters = &#123;</span></span><br><span class="line"><span class="meta">             @ComponentScan.Filter(type = FilterType.ANNOTATION, value = EnableWebMvc.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RootConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-编写-Controller"><a href="#2-编写-Controller" class="headerlink" title="2 编写 Controller"></a>2 编写 Controller</h3><h4 id="2-1-控制器类"><a href="#2-1-控制器类" class="headerlink" title="2.1 控制器类"></a>2.1 控制器类</h4><p>控制器类就是含有被 @RequestMapping 注解修饰的方法的类。@Controller 是 @Component 的别名，返回一个视图逻辑名称。</p>
<p>@RequestMapping 可加在类上和方法上，可同时映射多个路径</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeController</span> &#123;</span><br><span class="line">     <span class="meta">@RequestMapping(value = &#123; &quot;/&quot;, &quot;/homepage&quot; &#125;, method = RequestMethod.GET)</span></span><br><span class="line">     <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&quot;home&quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-请求参数"><a href="#2-2-请求参数" class="headerlink" title="2.2 请求参数"></a>2.2 请求参数</h4><p>Spring MVC 提供了三种方式，可以让客户端给控制器的 handler 传入参数：</p>
<h5 id="1）查询参数"><a href="#1）查询参数" class="headerlink" title="1）查询参数"></a>1）查询参数</h5><p>@RequestParam，可设默认和非必填</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Spittle&gt; <span class="title function_">spittles</span><span class="params">(<span class="meta">@RequestParam(&quot;max&quot;)</span> <span class="type">long</span> max, </span></span><br><span class="line"><span class="params">                              <span class="meta">@RequestParam(value = &quot;count&quot;, defaultValue = &quot;20&quot;)</span> <span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> spittleRepository.findSpittles(max, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2）表单参数"><a href="#2）表单参数" class="headerlink" title="2）表单参数"></a>2）表单参数</h5><ul>
<li>“redirect:”前缀：解析为重定向的规则， 而不是视图的名称。</li>
<li>“forward:”前缀：请求将会前往（forward） 指定的 URL 路径， 而不再是重定向。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/register&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(Spitter spitter)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/spitter/&quot;</span> + spitter.getUsername();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3）路径参数"><a href="#3）路径参数" class="headerlink" title="3）路径参数"></a>3）路径参数</h5><p>@PathVariable，如果函数参数和占位符名称相同，可省略注解的参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;abc/&#123;spittleId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">showSpittle</span><span class="params">(<span class="meta">@PathVariable(&quot;spittleId&quot;)</span> <span class="type">long</span> spittleId,Model model)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-3-校验参数"><a href="#2-3-校验参数" class="headerlink" title="2.3 校验参数"></a>2.3 校验参数</h4><p>Java Validation API 定义了多个注解， 这些注解可以放到属性上，从而限制这些属性的值。</p>
<table>
<thead>
<tr>
<th>注 解</th>
<th>描 述</th>
</tr>
</thead>
<tbody><tr>
<td>@AssertFalse</td>
<td>所注解的元素必须是 Boolean 类型， 并且值为 false</td>
</tr>
<tr>
<td>@AssertTrue</td>
<td>所注解的元素必须是 Boolean 类型， 并且值为 true</td>
</tr>
<tr>
<td>@DecimalMax</td>
<td>所注解的元素必须是数字， 并且它的值要小于或等于给定的 BigDecimalString 值</td>
</tr>
<tr>
<td>@DecimalMin</td>
<td>所注解的元素必须是数字， 并且它的值要大于或等于给定的 BigDecimalString 值</td>
</tr>
<tr>
<td>@Digits</td>
<td>所注解的元素必须是数字， 并且它的值必须有指定的位数</td>
</tr>
<tr>
<td>@Future</td>
<td>所注解的元素的值必须是一个将来的日期</td>
</tr>
<tr>
<td>@Max</td>
<td>所注解的元素必须是数字， 并且它的值要小于或等于给定的值</td>
</tr>
<tr>
<td>@Min</td>
<td>所注解的元素必须是数字， 并且它的值要大于或等于给定的值</td>
</tr>
<tr>
<td>@NotNull</td>
<td>所注解元素的值必须不能为 null</td>
</tr>
<tr>
<td>@Null</td>
<td>所注解元素的值必须为 null</td>
</tr>
<tr>
<td>@Past</td>
<td>所注解的元素的值必须是一个已过去的日期</td>
</tr>
<tr>
<td>@Pattern</td>
<td>所注解的元素的值必须匹配给定的正则表达式</td>
</tr>
<tr>
<td>@Size</td>
<td>所注解的元素的值必须是 String、 集合或数组， 并且它的长度要符合给定的范围</td>
</tr>
</tbody></table>
<h5 id="校验-bean-对象"><a href="#校验-bean-对象" class="headerlink" title="校验 bean 对象"></a>校验 bean 对象</h5><p>@Valid 注解标注要检验的参数，Errors 参数要紧跟其后面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/register&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(<span class="meta">@Valid</span> Spitter spitter, Errors errors)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/spitter/&quot;</span> + spitter.getUsername();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-4-其他注解"><a href="#2-4-其他注解" class="headerlink" title="2.4 其他注解"></a>2.4 其他注解</h4><ul>
<li>@RequestBody：将方法参数直接绑定到 HTTP 请求 Body 上</li>
<li>@ResponseBody：将返回值作为响应体</li>
<li>@RestController：避免重复写 @ResponseBody</li>
<li>@CookieValue</li>
<li>@RequestHeader</li>
</ul>
<p>Spring 4.3 中引进了｛@GetMapping、@PostMapping、@PutMapping、@DeleteMapping、@PatchMapping｝ 来帮助简化常用的 HTTP 方法的映射 并更好地表达被注解方法的语义</p>
<ul>
<li>@GetMapping 是一个组合注解：是 @RequestMapping(method &#x3D; RequestMethod.GET) 的缩写</li>
<li>@PostMapping 是一个组合注解：是 @RequestMapping(method &#x3D; RequestMethod.POST) 的缩写</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/21/Spring/Web/Spring%20MVC%20%E8%BF%9B%E9%98%B6/">Spring MVC 进阶</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/">spring</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/Web/">Web</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/spring/">spring</a></span><div class="content"><h3 id="1-替代配置"><a href="#1-替代配置" class="headerlink" title="1 替代配置"></a>1 替代配置</h3><h4 id="1-1-自定义-DispatcherServlet"><a href="#1-1-自定义-DispatcherServlet" class="headerlink" title="1.1 自定义 DispatcherServlet"></a>1.1 自定义 DispatcherServlet</h4><p>除了三个必须重载的抽象方法，AbstractAnnotationConfigDispatcherServletInitializer 还有很多方法可以重载，以实现额外配置。</p>
<p>例如，通过对 customizeRegistration() 的重写，就可以对 DispatcherServlet 进行额外的配置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizeRegistration</span><span class="params">(Dynamic registration)</span> &#123;</span><br><span class="line">    registration.setMultipartConfig(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(<span class="string">&quot;/tmp/spittr/uploads&quot;</span>)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServletRegistration.Dynamic 作为入参，可以做很多事情，比如调用 setLoadOnStartup() 来设置加载时优先级，调用 setInitParameter() 来设置初始化参数，调用 setMultipartConfig() 来设置 Servlet3.0 的多路支持。</p>
<h4 id="1-2-添加额外的-servlet-和-filter"><a href="#1-2-添加额外的-servlet-和-filter" class="headerlink" title="1.2 添加额外的 servlet 和 filter"></a>1.2 添加额外的 servlet 和 filter</h4><p>实现 WebApplicationInitializer 接口是在注册 servlet、filter、listener 时比较推荐的方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServletInitializer</span> <span class="keyword">implements</span> <span class="title class_">WebApplicationInitializer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="comment">// 定义servlet</span></span><br><span class="line">        <span class="type">Dynamic</span> <span class="variable">myServlet</span> <span class="operator">=</span> servletContext.addServlet(<span class="string">&quot;myServlet&quot;</span>, MyServlet.class);</span><br><span class="line">        <span class="comment">// 映射servlet</span></span><br><span class="line">        myServlet.addMapping(<span class="string">&quot;/custom/**&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册一个filter</span></span><br><span class="line">        javax.servlet.FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filter</span> <span class="operator">=</span> servletContext.addFilter(<span class="string">&quot;myFilter&quot;</span>, MyFilter.class);</span><br><span class="line">        <span class="comment">// 添加映射</span></span><br><span class="line">        filter.addMappingForUrlPatterns(<span class="literal">null</span>, <span class="literal">false</span>, <span class="string">&quot;/custom/*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如仅需要注册一个 filter 并将其映射到 DispatcherServlet，重写 AbstractAnnotationConfigDispatcherServletInitializer 的 getServletFilters() 方法是一个捷径。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Filter</span>[] &#123; <span class="keyword">new</span> <span class="title class_">MyFilter</span>() &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 getServletFilters() 返回的 filter 会自动地映射到 DispatcherServlet。</p>
<h3 id="2-处理-multipart-表单数据"><a href="#2-处理-multipart-表单数据" class="headerlink" title="2 处理 multipart 表单数据"></a>2 处理 multipart 表单数据</h3><p>Multipart&#x2F;form-data 将表单分割成独立的部分，每个部分都有各自的类型，可以处理二进制数据</p>
<h4 id="2-1-配置-multipart-解析器"><a href="#2-1-配置-multipart-解析器" class="headerlink" title="2.1 配置 multipart 解析器"></a>2.1 配置 multipart 解析器</h4><p>Spring 提供了两种 MultipartResolver 实现类：</p>
<ul>
<li>CommonsMultipartResolver：使用 Jakarta Commons FileUpload 来解析 multipart 请求；</li>
<li>StandardServletMultipartResolver：依靠 Servlet 3.0 支持来解析（Spring 3.1及以上）；</li>
</ul>
<p>推荐 StandardServletMultipartResolver，它使用 servlet 容器中现有的支持，并且不需要其他附加的项目依赖。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MultipartResolver <span class="title function_">multipartResolver</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StandardServletMultipartResolver</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="配置-multipart-详情"><a href="#配置-multipart-详情" class="headerlink" title="配置 multipart 详情"></a>配置 multipart 详情</h5><p>MultipartConfigElement</p>
<ol>
<li>继承自 WebMvcConfigurerAdapter 的 servlet 初始化类中配置的 DispatcherServlet，在 servlet 注册时通过调用 setMultipartConfig() 方法来配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">DispatcherServlet</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line"><span class="type">Dynamic</span> <span class="variable">registration</span> <span class="operator">=</span> context.addServlet(<span class="string">&quot;appServlet&quot;</span>, ds);</span><br><span class="line">registration.addMapping(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">registration.setMultipartConfig(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(<span class="string">&quot;/tmp/spittr/uploads&quot;</span>));</span><br></pre></td></tr></table></figure>

<ol>
<li>继承自 AbstractAnnotationConfigDispatcherServletInitializer 的 servlet 初始化类，重写 customizeRegistration() 方法来进行配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizeRegistration</span><span class="params">(Dynamic registration)</span> &#123;</span><br><span class="line">    registration.setMultipartConfig(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(<span class="string">&quot;/tmp/spittr/uploads&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-处理-multipart-请求"><a href="#2-2-处理-multipart-请求" class="headerlink" title="2.2 处理 multipart 请求"></a>2.2 处理 multipart 请求</h4><h5 id="1）表单"><a href="#1）表单" class="headerlink" title="1）表单"></a>1）表单</h5><p><code>标签 enctype=“multipart/form-data” 属性 </code>type&#x3D;“file”</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;form method=&quot;POST&quot; th:object=&quot;$&#123;spitter&#125;&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">...</span><br><span class="line">&lt;input type=&quot;file&quot; name=&quot;profilePicture&quot; accept=&quot;image/jpeg,image/png,image/gif&quot; /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h5 id="2）controller"><a href="#2）controller" class="headerlink" title="2）controller"></a>2）controller</h5><p>使用 <strong>@RequestPart</strong> 注解 byte 数组</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(<span class="meta">@RequestPart(&quot;profilePicture&quot;)</span> <span class="type">byte</span>[] profilePicture, <span class="meta">@Valid</span> Spitter spitter,Errors errors)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3）接收-MultipartFile"><a href="#3）接收-MultipartFile" class="headerlink" title="3）接收 MultipartFile"></a>3）接收 MultipartFile</h5><p>Spring 提供了 MultipartFile 接口获取富对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(<span class="meta">@RequestPart(&quot;profilePicture&quot;)</span> MultipartFile profilePicture, ...)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MultipartFile 提供获取上传文件的方法，同时提供了很多其他方法，比如原始文件名称、大小和内容类型等。另外还提供了一个 InputStream 可以将文件数据作为数据流读取。</p>
<p>transferTo() 写入到文件系统</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">profilePicture.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/data/spittr/&quot;</span> + profilePicture.getOriginalFilename()));</span><br></pre></td></tr></table></figure>

<h5 id="4）接收-Part"><a href="#4）接收-Part" class="headerlink" title="4）接收 Part"></a>4）接收 Part</h5><p>Servlet 3.0 的容器上，可以选择 Part，大多数情况下 Part 接口和 MultipartFile 没什么区别。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/register&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(<span class="meta">@RequestPart(&quot;profilePicture&quot;)</span> Part profilePicture, ...)</span> &#123;</span><br></pre></td></tr></table></figure>

<p>如果使用 Part 作为参数，就不再需要配置 StandardServletMultipartResolverbean，它只需在使用 MultipartFile 时进行配置。</p>
<h3 id="3-异常处理"><a href="#3-异常处理" class="headerlink" title="3 异常处理"></a>3 异常处理</h3><p>servlet 请求的输出只能是 servlet 响应。如果请求出现异常，需要将异常转换为 servlet 响应。</p>
<p>Spring 提供了一些将异常转化为响应的方法：</p>
<ul>
<li>某些 Spring 异常会自动的映射为特定的 HTTP 状态码；</li>
<li>使用<code>@ResponseStatus</code>注解将一个异常映射为 HTTP 状态码；</li>
<li>使用<code>ExceptionHandler</code>注解的方法可以用来处理异常</li>
</ul>
<h4 id="3-1-ResponseStatus"><a href="#3-1-ResponseStatus" class="headerlink" title="3.1 @ResponseStatus"></a>3.1 @ResponseStatus</h4><p>内置映射之外，可用<code>@ResponseStatus</code>注解将一个异常映射为 HTTP 状态码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseStatus(value=HttpStatus.NOT_FOUND, reason=&quot;Spittle Not Found&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpittleNotFoundException</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2-ExceptionHandler"><a href="#3-2-ExceptionHandler" class="headerlink" title="3.2 @ExceptionHandler"></a>3.2 @ExceptionHandler</h4><p>@ExceptionHandler 注解的方法在有指定异常抛出时执行，在同一个 controller 里通用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(DuplicateSpittleException.class)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleDuplicateSpittle</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;error/duplicate&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-3-ControllerAdvice"><a href="#3-3-ControllerAdvice" class="headerlink" title="3.3 @ControllerAdvice"></a>3.3 @ControllerAdvice</h4><p>控制器增强类，即使用<code>@ControllerAdvice</code>进行注解的类，由以下方法构成：</p>
<ul>
<li>@ExceptionHandler 注解的</li>
<li>@InitBinder 注解的</li>
<li>@ModelAttribute 注解的</li>
</ul>
<p>应用于所有 controller 的所有 @RequestMapping 注解的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ControllerExceptionHandler</span> <span class="keyword">extends</span> <span class="title class_">ResponseEntityExceptionHandler</span> &#123;</span><br><span class="line">	<span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handle</span><span class="params">(ValidationException exception)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;bad request, &quot;</span> + exception.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bad request, &quot;</span> + exception.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;BaseException.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; handleBaseException(<span class="keyword">final</span> Exception ex, WebRequest request) &#123;</span><br><span class="line">        <span class="type">BaseException</span> <span class="variable">baseEx</span> <span class="operator">=</span> (BaseException) ex;</span><br><span class="line">        <span class="keyword">return</span> handleExceptionInternal(ex, ErrorResponse.of(baseEx), <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(), baseEx.getHttpStatus(), request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ResponseEntity&lt;Object&gt; <span class="title function_">handleMethodArgumentNotValid</span><span class="params">(MethodArgumentNotValidException ex, HttpHeaders headers, HttpStatus status, WebRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handleExceptionInternal(ex, ErrorResponse.of(ex), headers, HttpStatus.BAD_REQUEST, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ResponseEntity&lt;Object&gt; <span class="title function_">handleMissingServletRequestParameter</span><span class="params">(MissingServletRequestParameterException ex, HttpHeaders headers, HttpStatus status, WebRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handleExceptionInternal(ex, <span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(ex.getMessage(), <span class="string">&quot;missing_request_parameter&quot;</span>), headers, status, request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ErrorResponse</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String code;</span><br><span class="line">        List&lt;String&gt; errors;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ErrorResponse</span><span class="params">(String message, String code)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ErrorResponse</span><span class="params">(String message, String code, List&lt;String&gt; errors)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">            <span class="built_in">this</span>.errors = errors;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ErrorResponse <span class="title function_">of</span><span class="params">(BaseException ex)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(ex.getMessage(), ex.getCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ErrorResponse <span class="title function_">of</span><span class="params">(MethodArgumentNotValidException ex)</span> &#123;</span><br><span class="line">            List&lt;String&gt; errors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (FieldError error : ex.getBindingResult().getFieldErrors()) &#123;</span><br><span class="line">                errors.add(error.getField() + <span class="string">&quot;: &quot;</span> + error.getDefaultMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (ObjectError error : ex.getBindingResult().getGlobalErrors()) &#123;</span><br><span class="line">                errors.add(error.getObjectName() + <span class="string">&quot;: &quot;</span> + error.getDefaultMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(<span class="string">&quot;输入不合法&quot;</span>, <span class="string">&quot;bad_request&quot;</span>, errors);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ErrorResponse <span class="title function_">of</span><span class="params">(Map&lt;String, Object&gt; errorAttributes)</span> &#123; <span class="comment">//其他异常</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ErrorResponse</span>((String) errorAttributes.get(<span class="string">&quot;message&quot;</span>), (String) errorAttributes.get(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getErrors</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> errors;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseException</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">HttpStatus</span> <span class="variable">httpStatus</span> <span class="operator">=</span> HttpStatus.BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;unknown_error&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InternalServerErrorException</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InternalServerErrorException</span> <span class="keyword">extends</span> <span class="title class_">BaseException</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        httpStatus = HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class="line">        code = <span class="string">&quot;internal_server_error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InternalServerErrorException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="string">&quot;系统内部发生未知异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InternalServerErrorException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InternalServerErrorException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-跨-redirect-传递数据"><a href="#4-跨-redirect-传递数据" class="headerlink" title="4 跨 redirect 传递数据"></a>4 跨 redirect 传递数据</h3><p>一般的，处理函数结束后，方法中的 model 数据都会作为 request 属性复制到 request 中，并且 request 会传递到视图中进行解析。</p>
<ul>
<li>forward 时，使用同一个 request，request 属性保留。</li>
<li>redirect 时，终止老 request，开启新 request。request 属性清空。</li>
</ul>
<p>redirect 时不能使用 model 传递数据了。但是还有其他方法：</p>
<ul>
<li>将数据转换为路径参数或者查询参数</li>
<li>在 flash 属性中发送数据</li>
</ul>
<h4 id="4-1-使用-URL-模版重定向"><a href="#4-1-使用-URL-模版重定向" class="headerlink" title="4.1 使用 URL 模版重定向"></a>4.1 使用 URL 模版重定向</h4><p>使用路径参数和查询参数传递简单数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(Spitter spitter, Model model)</span> &#123;</span><br><span class="line">    spitterRepository.save(spitter);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;username&quot;</span>, spitter.getUsername());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;spitterId&quot;</span>, spitter.getId());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/spitter/&#123;username&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>username 作为路径参数，spitterId 转为查询参数</p>
<h4 id="4-2-使用-flash-属性"><a href="#4-2-使用-flash-属性" class="headerlink" title="4.2 使用 flash 属性"></a>4.2 使用 flash 属性</h4><p>Spring 通过 Model 的子接口 RedirectAttributes 设置 flash 属性。</p>
<p>重定向前，所有的 flash 属性都会拷贝到 session 中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(Spitter spitter, RedirectAttributes model)</span> &#123;</span><br><span class="line">    spitterRepository.save(spitter);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;username&quot;</span>, spitter.getUsername());</span><br><span class="line">    model.addFlashAttribute(<span class="string">&quot;spitter&quot;</span>, spitter);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/spitter/&#123;username&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重定向后，存储在 session 中的 flash 属性会从 session 中移出到 model 中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;username&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">showSpitterProfile</span><span class="params">(<span class="meta">@PathVariable(&quot;username&quot;)</span> String username, Model model)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!model.containsAttribute(<span class="string">&quot;spitter&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">Spitter</span> <span class="variable">spitter</span> <span class="operator">=</span> spitterRepository.findByUsername(username);</span><br><span class="line">        model.addAttribute(spitter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;profile&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/21/Spring/Web/Spring%20RestTemplate/">Spring RestTemplate</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/">spring</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/Web/">Web</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/spring/">spring</a></span><div class="content"><p>RestTemplate 属于 Spring-Web，是 Spring 的同步客户端HTTP访问的中心类。简化了与 HTTP 服务器的通信，并应用了 RESTful 原则。</p>
<p>RestTemplate 默认依赖 JDK 的 HttpURLConnection 来建立 HTTP 连接。 可切换到使用不同的 HTTP 库，例如 Apache HttpComponents，Netty 和 OkHttp。</p>
<h3 id="1-组成"><a href="#1-组成" class="headerlink" title="1 组成"></a>1 组成</h3><p>RestTemplate 包含以下几个部分：</p>
<ul>
<li>HttpMessageConverter：对象转换器</li>
<li>ClientHttpRequestFactory：客户端连接器，默认是 JDK 的 HttpURLConnection</li>
<li>ResponseErrorHandler：异常处理</li>
<li>ClientHttpRequestInterceptor：请求拦截器</li>
</ul>
<p><img src="https://imine141.github.io/images/1545011851872.png" alt="img"></p>
<h3 id="2-初始化"><a href="#2-初始化" class="headerlink" title="2 初始化"></a>2 初始化</h3><p>初始化时，可以传入 ClientHttpRequestFactory，自定义参数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Bean</span><br><span class="line">RestTemplate restTemplate()&#123;</span><br><span class="line">    SimpleClientHttpRequestFactory requestFactory = new SimpleClientHttpRequestFactory();</span><br><span class="line">    //设置超时时间</span><br><span class="line">    requestFactory.setConnectTimeout(1000);</span><br><span class="line">    requestFactory.setReadTimeout(1000);</span><br><span class="line">    RestTemplate restTemplate = new RestTemplate(requestFactory);</span><br><span class="line">    return restTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private RestTemplate restTemplate;</span><br></pre></td></tr></table></figure>



<h3 id="3-访问服务"><a href="#3-访问服务" class="headerlink" title="3 访问服务"></a>3 访问服务</h3><h4 id="3-1-HTTP-方法"><a href="#3-1-HTTP-方法" class="headerlink" title="3.1 HTTP 方法"></a>3.1 HTTP 方法</h4><p>使用 java.net.URI 代替 String 形式的 URI，不会被 URL 编码两次<br>以 get 和 post 为例，更多见 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html">官网api</a></p>
<h5 id="1）GET"><a href="#1）GET" class="headerlink" title="1）GET"></a>1）GET</h5><ul>
<li>getForObject()</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(URI url, Class&lt;T&gt; responseType)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(String url, Class&lt;T&gt; responseType, Object... urlVariables)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; urlVariables)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>getForEntity()</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(URI url,Class&lt;T&gt; responseType)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(String url,Class&lt;T&gt; responseType,Object... uriVariables)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(String url,Class&lt;T&gt; responseType,Map&lt;String,?&gt; uriVariables)</span></span><br></pre></td></tr></table></figure>

<h5 id="2）POST"><a href="#2）POST" class="headerlink" title="2）POST"></a>2）POST</h5><ul>
<li>postForObject()</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(URI url,Object request,Class&lt;T&gt; responseType)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(String url,Object request,Class&lt;T&gt; responseType,Object... uriVariables)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(String url,Object request,Class&lt;T&gt; responseType,Map&lt;String,?&gt; uriVariables)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>postForEntity()</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(String url,<span class="meta">@NullableObject</span> request,Class&lt;T&gt; responseType,Object... uriVariables)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(String url,Object request,Class&lt;T&gt; responseType,Map&lt;String,?&gt; uriVariables)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(URI url,Object request,Class&lt;T&gt; responseType)</span></span><br></pre></td></tr></table></figure>

<h5 id="3）实例"><a href="#3）实例" class="headerlink" title="3）实例"></a>3）实例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">headers.add(<span class="string">&quot;X-Auth-Token&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">MultiValueMap&lt;String, String&gt; postParameters = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;String, String&gt;();</span><br><span class="line">postParameters.add(<span class="string">&quot;parameter1&quot;</span>, <span class="string">&quot;111&quot;</span>);</span><br><span class="line">postParameters.add(<span class="string">&quot;parameter2&quot;</span>, <span class="string">&quot;222&quot;</span>);</span><br><span class="line">postParameters.add(<span class="string">&quot;parameter3&quot;</span>, <span class="string">&quot;333&quot;</span>);</span><br><span class="line"></span><br><span class="line">HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;MultiValueMap&lt;String, String&gt;&gt;(postParameters, headers);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    result = restTemplate.postForObject(<span class="string">&quot;http://demo&quot;</span>, requestEntity, ParseResultVo.class);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RestClientException e) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-异常处理"><a href="#4-异常处理" class="headerlink" title="4 异常处理"></a>4 异常处理</h3><h5 id="1）捕获-HttpServerErrorException"><a href="#1）捕获-HttpServerErrorException" class="headerlink" title="1）捕获 HttpServerErrorException"></a>1）捕获 HttpServerErrorException</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        responseEntity = restTemplate.exchange(requestEntity, String.class);  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (HttpServerErrorException e) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (retryCount == <span class="number">3</span>) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> e;  </span><br><span class="line">        &#125;  </span><br><span class="line">        retryCount++;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h5 id="2）自定义异常处理"><a href="#2）自定义异常处理" class="headerlink" title="2）自定义异常处理"></a>2）自定义异常处理</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomErrorHandler</span> <span class="keyword">extends</span> <span class="title class_">DefaultResponseErrorHandler</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasError</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleError</span><span class="params">(ClientHttpResponse response, HttpStatus statusCode)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span>(statusCode.isError())&#123;</span><br><span class="line">            <span class="keyword">switch</span> (statusCode.series()) &#123;</span><br><span class="line">                <span class="keyword">case</span> CLIENT_ERROR:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpClientErrorException</span>(statusCode, response.getStatusText(), response.getHeaders(), <span class="built_in">this</span>.getResponseBody(response), <span class="built_in">this</span>.getCharset(response));</span><br><span class="line">                <span class="keyword">case</span> SERVER_ERROR:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpServerErrorException</span>(statusCode, response.getStatusText(), response.getHeaders(), <span class="built_in">this</span>.getResponseBody(response), <span class="built_in">this</span>.getCharset(response));</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownHttpStatusCodeException</span>(statusCode.value(), response.getStatusText(), response.getHeaders(), <span class="built_in">this</span>.getResponseBody(response), <span class="built_in">this</span>.getCharset(response));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestClientConfig</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();  </span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> <span class="title class_">CustomErrorHandler</span>());  </span><br><span class="line">        <span class="keyword">return</span> restTemplate;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>



<h3 id="5-设置连接池"><a href="#5-设置连接池" class="headerlink" title="5 设置连接池"></a>5 设置连接池</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestClientConfig</span> &#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span>  </span><br><span class="line">  <span class="keyword">public</span> ClientHttpRequestFactory <span class="title function_">httpRequestFactory</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpComponentsClientHttpRequestFactory</span>(httpClient());  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span>  </span><br><span class="line">  <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(httpRequestFactory());  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span>  </span><br><span class="line">  <span class="keyword">public</span> HttpClient <span class="title function_">httpClient</span><span class="params">()</span> &#123;  </span><br><span class="line">    Registry&lt;ConnectionSocketFactory&gt; registry = RegistryBuilder.&lt;ConnectionSocketFactory&gt; create()  </span><br><span class="line">        .register(<span class="string">&quot;http&quot;</span>, PlainConnectionSocketFactory.getSocketFactory())  </span><br><span class="line">        .register(<span class="string">&quot;https&quot;</span>, SSLConnectionSocketFactory.getSocketFactory())  </span><br><span class="line">        .build();  </span><br><span class="line">    <span class="type">PoolingHttpClientConnectionManager</span> <span class="variable">connectionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolingHttpClientConnectionManager</span>(registry);  </span><br><span class="line">    connectionManager.setMaxTotal(<span class="number">200</span>);  </span><br><span class="line">    connectionManager.setDefaultMaxPerRoute(<span class="number">20</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">RequestConfig</span> <span class="variable">requestConfig</span> <span class="operator">=</span> RequestConfig.custom()  </span><br><span class="line">        .setSocketTimeout(<span class="number">8000</span>)  </span><br><span class="line">        .setConnectTimeout(<span class="number">8000</span>)  </span><br><span class="line">        .setConnectionRequestTimeout(<span class="number">8000</span>)  </span><br><span class="line">        .build();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> HttpClientBuilder.create()  </span><br><span class="line">        .setDefaultRequestConfig(requestConfig)  </span><br><span class="line">        .setConnectionManager(connectionManager)  </span><br><span class="line">        .setConnectionManagerShared(<span class="literal">true</span>)<span class="comment">//设置共享连接池</span></span><br><span class="line">        .build();  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>



<h3 id="6-处理文件"><a href="#6-处理文件" class="headerlink" title="6 处理文件"></a>6 处理文件</h3><h4 id="6-1-发送文件"><a href="#6-1-发送文件" class="headerlink" title="6.1 发送文件"></a>6.1 发送文件</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">MultiValueMap&lt;String, Object&gt; multiPartBody = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();  </span><br><span class="line">multiPartBody.add(<span class="string">&quot;file&quot;</span>, <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;/tmp/user.txt&quot;</span>));  </span><br><span class="line">RequestEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = RequestEntity  </span><br><span class="line">        .post(uri)  </span><br><span class="line">        .contentType(MediaType.MULTIPART_FORM_DATA)  </span><br><span class="line">        .body(multiPartBody);  </span><br></pre></td></tr></table></figure>



<h4 id="6-2-下载文件"><a href="#6-2-下载文件" class="headerlink" title="6.2 下载文件"></a>6.2 下载文件</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 小文件  </span></span><br><span class="line"><span class="type">RequestEntity</span> <span class="variable">requestEntity</span> <span class="operator">=</span> RequestEntity.get(uri).build();  </span><br><span class="line">ResponseEntity&lt;<span class="type">byte</span>[]&gt; responseEntity = restTemplate.exchange(requestEntity, <span class="type">byte</span>[].class);  </span><br><span class="line"><span class="type">byte</span>[] downloadContent = responseEntity.getBody();  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 大文件  </span></span><br><span class="line">ResponseExtractor&lt;ResponseEntity&lt;File&gt;&gt; responseExtractor = <span class="keyword">new</span> <span class="title class_">ResponseExtractor</span>&lt;ResponseEntity&lt;File&gt;&gt;() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;File&gt; <span class="title function_">extractData</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">File</span> <span class="variable">rcvFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;rcvFile&quot;</span>, <span class="string">&quot;zip&quot;</span>);  </span><br><span class="line">        FileCopyUtils.copy(response.getBody(), <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(rcvFile));  </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(response.getStatusCode()).headers(response.getHeaders()).body(rcvFile);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"><span class="type">File</span> <span class="variable">getFile</span> <span class="operator">=</span> <span class="built_in">this</span>.restTemplate.execute(targetUri, HttpMethod.GET, <span class="literal">null</span>, responseExtractor);  </span><br></pre></td></tr></table></figure>



<h3 id="7-Spring-Boot"><a href="#7-Spring-Boot" class="headerlink" title="7 Spring Boot"></a>7 Spring Boot</h3><p>RestTemplateBuilder</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomRestTemplateCustomizer</span> <span class="keyword">implements</span> <span class="title class_">RestTemplateCustomizer</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(RestTemplate restTemplate)</span> &#123;  </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RestTemplateBuilder</span>()  </span><br><span class="line">                .detectRequestFactory(<span class="literal">false</span>)  </span><br><span class="line">                .basicAuthorization(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;password&quot;</span>)  </span><br><span class="line">                .uriTemplateHandler(<span class="keyword">new</span> <span class="title class_">OkHttp3ClientHttpRequestFactory</span>())  </span><br><span class="line">                .errorHandler(<span class="keyword">new</span> <span class="title class_">CustomResponseErrorHandler</span>())  </span><br><span class="line">                .configure(restTemplate);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>单独设置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRestClientService</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRestClientService</span><span class="params">(RestTemplateBuilder restTemplateBuilder)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.restTemplate = restTemplateBuilder  </span><br><span class="line">            .basicAuthorization(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;password&quot;</span>)  </span><br><span class="line">            .setConnectTimeout(<span class="number">3000</span>)  </span><br><span class="line">            .setReadTimeout(<span class="number">5000</span>)  </span><br><span class="line">            .rootUri(<span class="string">&quot;http://api.example.com/&quot;</span>)  </span><br><span class="line">            .errorHandler(<span class="keyword">new</span> <span class="title class_">CustomResponseErrorHandler</span>())  </span><br><span class="line">            .additionalMessageConverters(<span class="keyword">new</span> <span class="title class_">CustomHttpMessageConverter</span>())  </span><br><span class="line">            .uriTemplateHandler(<span class="keyword">new</span> <span class="title class_">OkHttp3ClientHttpRequestFactory</span>())  </span><br><span class="line">            .build();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">site</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.restTemplate.getForObject(<span class="string">&quot;http://rensanning.iteye.com/&quot;</span>, String.class);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>



<h3 id="8-参数设置"><a href="#8-参数设置" class="headerlink" title="8 参数设置"></a>8 参数设置</h3><h4 id="8-1-指定转换器"><a href="#8-1-指定转换器" class="headerlink" title="8.1 指定转换器"></a>8.1 指定转换器</h4><p>RestTemplate 默认注册了一组 HttpMessageConverter 用来处理一些不同的 contentType 的请求。</p>
<p>StringHttpMessageConverter 来处理 text&#x2F;plain;</p>
<p>MappingJackson2HttpMessageConverter 来处理 application&#x2F;json;</p>
<p>MappingJackson2XmlHttpMessageConverter 来处理 application&#x2F;xml。</p>
<p>可实现 org.springframework.http.converter.HttpMessageConverter 接口自己写一个转换器。</p>
<p>替换例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取RestTemplate默认配置好的所有转换器</span></span><br><span class="line">List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = restTemplate.getMessageConverters();</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认的MappingJackson2HttpMessageConverter在第7个 先把它移除掉</span></span><br><span class="line">messageConverters.remove(<span class="number">6</span>); </span><br><span class="line"><span class="comment">//添加上GSON的转换器</span></span><br><span class="line">messageConverters.add(<span class="number">6</span>, <span class="keyword">new</span> <span class="title class_">GsonHttpMessageConverter</span>());</span><br></pre></td></tr></table></figure>



<h4 id="8-2-设置底层连接方式"><a href="#8-2-设置底层连接方式" class="headerlink" title="8.2 设置底层连接方式"></a>8.2 设置底层连接方式</h4><p>通过构造参数设置，以切换 HttpClient 为例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//生成一个设置了连接超时时间、请求超时时间、异常最大重试次数的 httpClient</span></span><br><span class="line"><span class="type">RequestConfig</span> <span class="variable">config</span> <span class="operator">=</span> RequestConfig.custom().setConnectionRequestTimeout(<span class="number">10000</span>).setConnectTimeout(<span class="number">10000</span>).setSocketTimeout(<span class="number">30000</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="type">HttpClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> HttpClientBuilder.create().setDefaultRequestConfig(config).setRetryHandler(<span class="keyword">new</span> <span class="title class_">DefaultHttpRequestRetryHandler</span>(<span class="number">5</span>, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">HttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> builder.build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用httpClient创建一个 ClientHttpRequestFactory 的实现</span></span><br><span class="line"><span class="type">ClientHttpRequestFactory</span> <span class="variable">requestFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpComponentsClientHttpRequestFactory</span>(httpClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ClientHttpRequestFactory作为参数构造一个使用作为底层的 RestTemplate</span></span><br><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(requestFactory);</span><br></pre></td></tr></table></figure>



<h4 id="8-3-设置拦截器"><a href="#8-3-设置拦截器" class="headerlink" title="8.3 设置拦截器"></a>8.3 设置拦截器</h4><p>拦截器需要我们实现 org.springframework.http.client.ClientHttpRequestInterceptor 接口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ClientHttpRequestInterceptor</span>&#123; </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> ClientHttpResponse <span class="title function_">intercept</span><span class="params">(HttpRequest request, <span class="type">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//请求地址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">checkTokenUrl</span> <span class="operator">=</span> request.getURI().getPath(); </span><br><span class="line">        <span class="comment">//请求方法名 POST、GET等</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> request.getMethod().name(); </span><br><span class="line">        <span class="comment">//请求内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">requestBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body); </span><br><span class="line">        <span class="comment">//……</span></span><br><span class="line">        <span class="keyword">return</span> execution.execute(request, body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 RestTemplate 实例的时候，添加拦截器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//向restTemplate中添加自定义的拦截器</span></span><br><span class="line">restTemplate.getInterceptors().add(<span class="keyword">new</span> <span class="title class_">TokenInterceptor</span>());</span><br></pre></td></tr></table></figure>



<h4 id="8-4-使用-Proxy"><a href="#8-4-使用-Proxy" class="headerlink" title="8.4 使用 Proxy"></a>8.4 使用 Proxy</h4><h5 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">SimpleClientHttpRequestFactory</span> <span class="variable">requestFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleClientHttpRequestFactory</span>();</span><br><span class="line">    <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(Proxy.Type.HTTP, <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;your.proxy.server&quot;</span>, <span class="number">8080</span>));</span><br><span class="line">    requestFactory.setProxy(proxy);</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(requestFactory);</span><br><span class="line">    <span class="keyword">return</span> restTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="System-properties"><a href="#System-properties" class="headerlink" title="System properties"></a>System properties</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> System.getProperties();</span><br><span class="line">props.put(<span class="string">&quot;https.proxyHost&quot;</span>, <span class="string">&quot;your.proxy.server&quot;</span>);</span><br><span class="line">props.put(<span class="string">&quot;https.proxyPort&quot;</span>, <span class="string">&quot;8080&quot;</span>);</span><br><span class="line">props.put(<span class="string">&quot;http.proxyHost&quot;</span>, <span class="string">&quot;your.proxy.server&quot;</span>);</span><br><span class="line">props.put(<span class="string">&quot;http.proxyPort&quot;</span>, <span class="string">&quot;8080&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">tt</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;https://baike.baidu.com/&quot;</span>,String.class);</span><br><span class="line">System.out.println(tt);</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/21/Spring/Web/%E8%B7%A8%E5%9F%9F/">跨域</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/">spring</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/Web/">Web</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/spring/">spring</a></span><div class="content"><p>常用的跨域解决方案有 JSONP 和 CORS， spingboot 2.0 开始不推荐使用 JSONP。</p>
<h2 id="1-CORS"><a href="#1-CORS" class="headerlink" title="1 CORS"></a>1 CORS</h2><h3 id="1-1-属性含义"><a href="#1-1-属性含义" class="headerlink" title="1.1 属性含义"></a>1.1 属性含义</h3><table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>指定所支持域的集合， 表示所有域都支持，默认值为 。这些值对应于 HTTP 请求头中的 Access-Control-Allow-Origin</td>
</tr>
<tr>
<td>origins</td>
<td>@AliasFor(“value”)，与 value 属性一样</td>
</tr>
<tr>
<td>allowedHeaders</td>
<td>允许请求头中的 headers，在预检请求 Access-Control-Allow-Headers 响应头中展示</td>
</tr>
<tr>
<td>exposedHeaders</td>
<td>响应头中允许访问的 headers，在实际请求的 Access-Control-Expose-Headers</td>
</tr>
<tr>
<td>methods</td>
<td>支持的 HTTP 请求方法列表，默认和 Controller 中的方法上标注的一致。</td>
</tr>
<tr>
<td>allowCredentials</td>
<td>表示浏览器在跨域请求中是否携带凭证，比如 cookies。在预检请求的 Access-Control-Allow-Credentials</td>
</tr>
<tr>
<td>maxAge</td>
<td>预检请求响应的最大缓存时间，单位为秒。在预检请求的 Access-Control-Max-Age 响应头中展示</td>
</tr>
</tbody></table>
<h3 id="1-2-实现方法"><a href="#1-2-实现方法" class="headerlink" title="1.2 实现方法"></a>1.2 实现方法</h3><h4 id="1）-CrossOrigin-注解"><a href="#1）-CrossOrigin-注解" class="headerlink" title="1） CrossOrigin 注解"></a>1） CrossOrigin 注解</h4><p>在 Spring Boot 中为我们提供了一个注解 @CrossOrigin 来实现跨域，这个注解可以加在类或者方法上。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/xxx&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@CrossOrigin</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">xxx</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2）实现-WebMvcConfigurer-接口"><a href="#2）实现-WebMvcConfigurer-接口" class="headerlink" title="2）实现 WebMvcConfigurer 接口"></a>2）实现 WebMvcConfigurer 接口</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CorsConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .allowedMethods(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;HEAD&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;OPTIONS&quot;</span>)</span><br><span class="line">                .allowCredentials(<span class="literal">true</span>)</span><br><span class="line">                .maxAge(<span class="number">168000</span>)</span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3）过滤器"><a href="#3）过滤器" class="headerlink" title="3）过滤器"></a>3）过滤器</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CorsConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line">        <span class="type">FilterRegistrationBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>(<span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source));</span><br><span class="line">        bean.setOrder(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-Jsonp"><a href="#2-Jsonp" class="headerlink" title="2 Jsonp"></a>2 Jsonp</h2><blockquote>
<p>spingboot2.0 已不支持 JSONP</p>
</blockquote>
<p>通过 jsonp 调用，对格式重新封装，解决前端跨域。<br>如：请求<code>http://xxxx?&amp;callback=exec</code>, 那么返回的jsonp格式为<code>exec(&#123;&quot;code&quot;:0, &quot;message&quot;:&quot;success&quot;&#125;);</code>。</p>
<p>继承<code>AbstractJsonpResponseBodyAdvice</code>，加入<code>@ControllerAdvice</code>注解,basePackages 标识要被处理的 controller。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice(basePackages = &quot;xxx.controller&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonpAdvice</span> <span class="keyword">extends</span> <span class="title class_">AbstractJsonpResponseBodyAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] jsonpQueryParamNames;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JsonpAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="string">&quot;callback&quot;</span>, <span class="string">&quot;jsonp&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.jsonpQueryParamNames = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;callback&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeBodyWriteInternal</span><span class="params">(MappingJacksonValue bodyContainer, MediaType contentType, MethodParameter returnType, ServerHttpRequest request, ServerHttpResponse response)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> ((ServletServerHttpRequest) request).getServletRequest();</span><br><span class="line">　　　　　</span><br><span class="line">　　　　<span class="comment">//如果不存在callback这个请求参数，直接返回，不需要处理为jsonp</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(servletRequest.getParameter(<span class="string">&quot;callback&quot;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">　　　　<span class="comment">//按设定的请求参数处理返回结果为jsonp格式</span></span><br><span class="line">        <span class="keyword">for</span> (String name : <span class="built_in">this</span>.jsonpQueryParamNames) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> servletRequest.getParameter(name);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">MediaType</span> <span class="variable">contentTypeToUse</span> <span class="operator">=</span> getContentType(contentType, request, response);</span><br><span class="line">                response.getHeaders().setContentType(contentTypeToUse);</span><br><span class="line">                bodyContainer.setJsonpFunction(value);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/20/Spring/Data/Ehcache%203.8%20%E7%AE%80%E5%8D%95%E6%8C%81%E4%B9%85%E5%8C%96/">Ehcache 3.8 简单持久化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-20</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/">spring</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/Data/">Data</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/spring/">spring</a></span><div class="content"><h3 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1 引入依赖"></a>1 引入依赖</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.ehcache&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;ehcache&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.8.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<h3 id="2-持久化配置"><a href="#2-持久化配置" class="headerlink" title="2 持久化配置"></a>2 持久化配置</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EhcacheHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CacheManager cacheManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CacheManager <span class="title function_">getCacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isAvailable())&#123;</span><br><span class="line">            cacheManager = CacheManagerBuilder.newCacheManagerBuilder()</span><br><span class="line">                    .with(CacheManagerBuilder.persistence(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;java.io.tmpdir&quot;</span>, <span class="string">&quot;EhcacheData&quot;</span>)))</span><br><span class="line">                    .withCache(<span class="string">&quot;xxxCache&quot;</span>,</span><br><span class="line">                            CacheConfigurationBuilder.newCacheConfigurationBuilder(Long.class, String.class,</span><br><span class="line">                                    ResourcePoolsBuilder.newResourcePoolsBuilder()</span><br><span class="line">                                            .heap(<span class="number">2000</span>, EntryUnit.ENTRIES)</span><br><span class="line">                                            .offheap(<span class="number">1</span>, MemoryUnit.MB)</span><br><span class="line">                                            .disk(<span class="number">20</span>, MemoryUnit.MB, <span class="literal">true</span>)</span><br><span class="line">                            )</span><br><span class="line">                    ).build(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(isAvailable())&#123;</span><br><span class="line">            cacheManager.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title function_">isAvailable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> != cacheManager &amp;&amp; cacheManager.getStatus().equals(Status.AVAILABLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-使用示例"><a href="#3-使用示例" class="headerlink" title="3 使用示例"></a>3 使用示例</h3><p>存放</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCache</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">CacheManager</span> <span class="variable">persistentCacheManager</span> <span class="operator">=</span> EhcacheHelper.getCacheManager();</span><br><span class="line">    Cache&lt;Long, String&gt; persistentCache = persistentCacheManager.getCache(<span class="string">&quot;threeTieredCache&quot;</span>, Long.class, String.class);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i &lt; <span class="number">100</span>;i ++)&#123;</span><br><span class="line">        persistentCache.put(i, <span class="string">&quot;这是第:-&quot;</span> + i + <span class="string">&quot;-条信息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    persistentCache.forEach( cc -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">&quot;persistentCache,主键：&#123;&#125;，值：&#123;&#125;&quot;</span>,cc.getKey(),cc.getValue());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    persistentCacheManager.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>取用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getCache</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">CacheManager</span> <span class="variable">persistentCacheManager</span> <span class="operator">=</span> EhcacheHelper.getCacheManager();</span><br><span class="line">    Cache&lt;Long, String&gt; persistentCache = persistentCacheManager.getCache(<span class="string">&quot;threeTieredCache&quot;</span>, Long.class, String.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    Iterator&lt;Cache.Entry&lt;Long,String&gt;&gt; iterator = persistentCache.iterator();</span><br><span class="line">    <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">        ++ count;</span><br><span class="line">        Cache.Entry&lt;Long,String&gt; entry = iterator.next();</span><br><span class="line">        log.info(<span class="string">&quot;threeTieredCache,主键：&#123;&#125;，值：&#123;&#125;&quot;</span>,entry.getKey(),entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;信息的总条数为：&#123;&#125;&quot;</span>,count);</span><br><span class="line">    persistentCacheManager.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-关闭钩子"><a href="#4-关闭钩子" class="headerlink" title="4 关闭钩子"></a>4 关闭钩子</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SkuSyncApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将 hook 线程添加到运行时环境中去</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                EhcacheHelper.close();</span><br><span class="line">                System.out.println(<span class="string">&quot;ShutdownHook ==&gt; Ehcache closed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/20/Spring/Data/Transaction/">Transaction</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-20</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/">spring</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/Data/">Data</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/spring/">spring</a></span><div class="content"><p>Spring 事务的本质是数据库对事务的支持。</p>
<p><code>@EnableTransactionManagement</code> 开启对事务注解的解析</p>
<h3 id="1-声明式事务"><a href="#1-声明式事务" class="headerlink" title="1 声明式事务"></a>1 声明式事务</h3><h4 id="1-1-Transactional-注解"><a href="#1-1-Transactional-注解" class="headerlink" title="1.1 @Transactional 注解"></a>1.1 @Transactional 注解</h4><table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>String</td>
<td>事务管理器</td>
</tr>
<tr>
<td>propagation</td>
<td>Propagation</td>
<td>传播级别</td>
</tr>
<tr>
<td>isolation</td>
<td>Isolation</td>
<td>隔离级别</td>
</tr>
<tr>
<td>readOnly</td>
<td>boolean</td>
<td>读&#x2F;写与只读事务</td>
</tr>
<tr>
<td>timeout</td>
<td>int</td>
<td>事务超时(秒)</td>
</tr>
<tr>
<td>rollbackFor</td>
<td>Class</td>
<td>触发事务回滚的类，默认只对未检查异常有效</td>
</tr>
<tr>
<td>noRollbackFor</td>
<td>Class</td>
<td>设置不需要进行回滚的异常类数组</td>
</tr>
</tbody></table>
<h4 id="1-2-Transactional-特性"><a href="#1-2-Transactional-特性" class="headerlink" title="1.2 Transactional 特性"></a>1.2 Transactional 特性</h4><ul>
<li>类上添加 @Transactional，在每个方法单开一个事务，管理方式相同。</li>
<li>@Transactional 注解只在 public 方法上起作用。</li>
<li>默认只对未检查异常回滚</li>
<li>只读事务只在事务启动时应用，否则即使配置也会被忽略。</li>
</ul>
<h4 id="1-3-传播级别"><a href="#1-3-传播级别" class="headerlink" title="1.3 传播级别"></a>1.3 传播级别</h4><ul>
<li>PROPAGATION_REQUIRED<br>（默认设置）存在则加入，没有则创建</li>
<li>PROPAGATION_REQUIRES_NEW<br>创建新事务，如当前事务存在，则挂起当前事务</li>
<li>PROPAGATION_SUPPORTS<br>存在则加入；没有则以非事务的方式运行</li>
<li>PROPAGATION_NOT_SUPPORTED<br>以非事务方式运行，如果当前存在事务，则把当前事务挂起。</li>
<li>PROPAGATION_MANDATORY<br>如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</li>
<li>PROPAGATION_NEVER<br>以非事务方式运行，如果当前存在事务，则抛出异常</li>
<li>PROPAGATION_NESTED<br>存在则创建嵌套事务；没有则创建</li>
</ul>
<h4 id="1-4-隔离级别"><a href="#1-4-隔离级别" class="headerlink" title="1.4 隔离级别"></a>1.4 隔离级别</h4><ul>
<li>ISOLATION_DEFAULT<br>（默认设置）使用底层数据库的默认隔离级别。</li>
<li>ISOLATION_READ_UNCOMMITTED<br>可读取修改还没有提交的数据</li>
<li>ISOLATION_READ_COMMITTED<br>只能读取已经提交的数据。推荐。</li>
<li>ISOLATION_REPEATABLE_READ<br>可重复读，每次返回相同。</li>
<li>ISOLATION_SERIALIZABLE<br>逐个执行事务，性能低。</li>
</ul>
<h3 id="2-编程式事务"><a href="#2-编程式事务" class="headerlink" title="2 编程式事务"></a>2 编程式事务</h3><h4 id="2-1-TransactionTemplate"><a href="#2-1-TransactionTemplate" class="headerlink" title="2.1 TransactionTemplate"></a>2.1 TransactionTemplate</h4><p>在 doIntransaction 里处理逻辑。如果出异常了，就执行 isRollbackOnly 方法进行回滚。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">TransactionTemplate transactionTemplate;</span><br><span class="line"></span><br><span class="line">transactionTemplate.execute((TransactionStatus transactionStatus) -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        transactionStatus.isRollbackOnly();</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="2-2-TransactionManager"><a href="#2-2-TransactionManager" class="headerlink" title="2.2 TransactionManager"></a>2.2 TransactionManager</h4><p>手动 commit，异常就 rollback</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> transactionManager.getTransaction(<span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    userRepository.save(user);</span><br><span class="line">    transactionManager.commit(status);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    transactionManager.rollback(status);</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/07/19/Spring/Data/Dynamic%20DataSource/">Dynamic DataSource</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-19</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/">spring</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/spring/Data/">Data</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/spring/">spring</a></span><div class="content"><h2 id="一、AOP-实现"><a href="#一、AOP-实现" class="headerlink" title="一、AOP 实现"></a>一、AOP 实现</h2><p>AOP 实现多数据源，可读写分离</p>
<h3 id="1-配置文件"><a href="#1-配置文件" class="headerlink" title="1 配置文件"></a>1 配置文件</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">dynamic-db.master.driver-class-name = com.mysql.jdbc.Driver</span><br><span class="line">dynamic-db.master.jdbc-url = jdbc:mysql:<span class="comment">//somehost:3306/sometable?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">dynamic-db.master.username = xxx</span><br><span class="line">dynamic-db.master.password = xxx</span><br><span class="line"></span><br><span class="line">dynamic-db.slave.driver-class-name = com.mysql.jdbc.Driver</span><br><span class="line">dynamic-db.slave.jdbc-url = jdbc:mysql:<span class="comment">//somehost:3306/sometable?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">dynamic-db.slave.username = xxx</span><br><span class="line">dynamic-db.slave.password = xxx</span><br></pre></td></tr></table></figure>



<h3 id="2-ContextHolder"><a href="#2-ContextHolder" class="headerlink" title="2 ContextHolder"></a>2 ContextHolder</h3><p>管理 DataSource</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceContextHolder</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储当前 DataSource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; CONTEXT_HOLDER = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有 DataSource 的 key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Object&gt; dataSourceKeys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切换 DataSource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setDataSourceKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        CONTEXT_HOLDER.set(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前 DataSource，默认为 master</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDataSourceKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CONTEXT_HOLDER.get();</span><br><span class="line">        <span class="keyword">return</span> key == <span class="literal">null</span> ? <span class="string">&quot;master&quot;</span> : key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空当前 DataSource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearDataSourceKey</span><span class="params">()</span> &#123;</span><br><span class="line">        CONTEXT_HOLDER.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否当前 DataSource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">containDataSourceKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataSourceKeys.contains(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-注册动态配置"><a href="#3-注册动态配置" class="headerlink" title="3 注册动态配置"></a>3 注册动态配置</h3><p>继承 AbstractRoutingDataSource</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicRoutingDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    <span class="comment">//将当前DataSource加入应用上下文</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DynamicDataSourceContextHolder.getDataSourceKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-加载配置"><a href="#4-加载配置" class="headerlink" title="4 加载配置"></a>4 加载配置</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;master&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;dynamic-db.master&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">master</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(&quot;slave&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;dynamic-db.slave&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置动态 DataSource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;dynamicDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dynamicDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DynamicRoutingDataSource</span> <span class="variable">dynamicRoutingDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicRoutingDataSource</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//所有DataSource</span></span><br><span class="line">        Map&lt;Object, Object&gt; dataSourceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        dataSourceMap.put(<span class="string">&quot;master&quot;</span>, master());</span><br><span class="line">        dataSourceMap.put(<span class="string">&quot;slave&quot;</span>, slave());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置默认DataSource</span></span><br><span class="line">        dynamicRoutingDataSource.setDefaultTargetDataSource(master());</span><br><span class="line">        <span class="comment">//设置所有DataSource</span></span><br><span class="line">        dynamicRoutingDataSource.setTargetDataSources(dataSourceMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将所有DataSource的key放入，以供判断</span></span><br><span class="line">        DynamicDataSourceContextHolder.dataSourceKeys.addAll(dataSourceMap.keySet());</span><br><span class="line">        <span class="keyword">return</span> dynamicRoutingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将数据源添加到 SqlSession 工厂；获取 mybatis 配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;mybatis&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dynamicDataSource());</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将数据源添加到事物管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dynamicDataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-注解"><a href="#5-注解" class="headerlink" title="5 注解"></a>5 注解</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TargetDataSource &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-Aspect"><a href="#6-Aspect" class="headerlink" title="6 Aspect"></a>6 Aspect</h3><p>要用 @Order(0) 注解让这个切面的优先级最高，以免被其他切面（如事务管理器）影响</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSourceAspect</span> &#123;</span><br><span class="line">    <span class="comment">//切换</span></span><br><span class="line">    <span class="meta">@Before(&quot;@annotation(targetDataSource))</span><span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void switchDataSource(JoinPoint point, TargetDataSource targetDataSource) &#123;</span></span><br><span class="line"><span class="string">        if (DynamicDataSourceContextHolder.containDataSourceKey(targetDataSource.value()))&#123;</span></span><br><span class="line"><span class="string">            DynamicDataSourceContextHolder.setDataSourceKey(targetDataSource.value());</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    //还原</span></span><br><span class="line"><span class="string">    @After(&quot;</span><span class="meta">@annotation(targetDataSource)</span>)<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public void restoreDataSource(JoinPoint point, TargetDataSource targetDataSource) &#123;</span></span><br><span class="line"><span class="string">        DynamicDataSourceContextHolder.clearDataSourceKey();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="7-实例"><a href="#7-实例" class="headerlink" title="7 实例"></a>7 实例</h3><p>读写分离</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InterMsgMapper</span> &#123;</span><br><span class="line">    <span class="meta">@InsertProvider(type = InterMsgProvider.class, method = &quot;insert&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(InterMsg interMsg)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetDataSource(&quot;slave&quot;)</span></span><br><span class="line">    <span class="meta">@SelectProvider(type = InterMsgProvider.class, method = &quot;findMessages&quot;)</span></span><br><span class="line">    List&lt;InterMsg&gt; <span class="title function_">findMessages</span><span class="params">(Long userId, Integer limit, Long lastId, Long currentTime)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="二、普通配置"><a href="#二、普通配置" class="headerlink" title="二、普通配置"></a>二、普通配置</h2><h3 id="1-配置文件-1"><a href="#1-配置文件-1" class="headerlink" title="1 配置文件"></a>1 配置文件</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">dynamic-db.master.driver-class-name = com.mysql.jdbc.Driver</span><br><span class="line">dynamic-db.master.jdbc-url = jdbc:mysql:<span class="comment">//somehost:3306/sometable?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">dynamic-db.master.username = xxx</span><br><span class="line">dynamic-db.master.password = xxx</span><br><span class="line"></span><br><span class="line">dynamic-db.slave.driver-class-name = com.mysql.jdbc.Driver</span><br><span class="line">dynamic-db.slave.jdbc-url = jdbc:mysql:<span class="comment">//somehost:3306/sometable?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">dynamic-db.slave.username = xxx</span><br><span class="line">dynamic-db.slave.password = xxx</span><br></pre></td></tr></table></figure>



<h3 id="2-DataSourceConfig"><a href="#2-DataSourceConfig" class="headerlink" title="2 DataSourceConfig"></a>2 DataSourceConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line">    <span class="comment">//开启 数据库下划线转驼峰</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span> <span class="comment">//默认单例会使多数据源失效</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;mybatis.configuration&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> org.apache.ibatis.session.Configuration <span class="title function_">globalConfiguration</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.ibatis.session.Configuration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;masterDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;dynamic-db.master&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">master</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(&quot;slaveDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;dynamic-db.slave&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//多数据源事务管理</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;tranMagMaster&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">bfTransactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;masterDataSource&quot;)</span>DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(name=&quot;tranMagSlave&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">bfscrmTransactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;slaveDataSource&quot;)</span>DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-JdbcTemplatesConfig"><a href="#3-JdbcTemplatesConfig" class="headerlink" title="3 JdbcTemplatesConfig"></a>3 JdbcTemplatesConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcTemplatesConfig</span> <span class="keyword">extends</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支持JdbcTemplate实现多数据源</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;masterJdbcTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> JdbcTemplate <span class="title function_">masterJdbcTemplate</span><span class="params">(<span class="meta">@Qualifier(&quot;masterDataSource&quot;)</span> DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name=&quot;slaveJdbcTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> JdbcTemplate <span class="title function_">slaveJdbcTemplate</span><span class="params">(<span class="meta">@Qualifier(&quot;slaveDataSource&quot;)</span> DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-MybatisConfigMaster"><a href="#3-MybatisConfigMaster" class="headerlink" title="3 MybatisConfigMaster"></a>3 MybatisConfigMaster</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &quot;com.xxx.mapper.master&quot;, </span></span><br><span class="line"><span class="meta">        sqlSessionTemplateRef = &quot;masterSqlSessionTemplate&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfigMaster</span> <span class="keyword">extends</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    SqlSessionFactory <span class="title function_">masterSqlSessionFactory</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">            sqlSessionFactoryBean.setConfiguration(globalConfiguration());</span><br><span class="line">            sqlSessionFactoryBean.setDataSource(masterDataSource());</span><br><span class="line">            sqlSessionFactory = sqlSessionFactoryBean.getObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    SqlSessionTemplate <span class="title function_">masterSqlSessionTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(masterSqlSessionFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-MybatisConfigSlave"><a href="#4-MybatisConfigSlave" class="headerlink" title="4 MybatisConfigSlave"></a>4 MybatisConfigSlave</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &quot;com.xxx.mapper.slave&quot;, </span></span><br><span class="line"><span class="meta">        sqlSessionTemplateRef = &quot;slaveSqlSessionTemplate&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfigSlave</span> <span class="keyword">extends</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    SqlSessionFactory <span class="title function_">slaveSqlSessionFactory</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">            sqlSessionFactoryBean.setConfiguration(globalConfiguration());</span><br><span class="line">            sqlSessionFactoryBean.setDataSource(slaveDataSource());</span><br><span class="line">            sqlSessionFactory = sqlSessionFactoryBean.getObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    SqlSessionTemplate <span class="title function_">slaveSqlSessionTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(slaveSqlSessionFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-使用"><a href="#5-使用" class="headerlink" title="5 使用"></a>5 使用</h3><p>在 @MapperScan 配置的目录下写 mapper 就行了</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2024 By iMine</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>