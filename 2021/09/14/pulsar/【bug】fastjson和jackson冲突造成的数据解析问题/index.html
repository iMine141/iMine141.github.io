<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="fastjson和jackson冲突造成的数据解析问题"><meta name="keywords" content="pulsar"><meta name="author" content="iMine"><meta name="copyright" content="iMine"><title>fastjson和jackson冲突造成的数据解析问题 | iMineのBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?434d6055a3a5266f2c2a21749e588070";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-版本"><span class="toc-text">1. 版本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-问题"><span class="toc-text">2. 问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-问题解决"><span class="toc-text">3. 问题解决</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-问题排查"><span class="toc-text">4. 问题排查</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-问题确认"><span class="toc-text">4.1 问题确认</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-在问题出现的地方找原因"><span class="toc-text">4.2 在问题出现的地方找原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-查看调用链"><span class="toc-text">4.3 查看调用链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-问题分析"><span class="toc-text">4.4 问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-问题解决"><span class="toc-text">4.5 问题解决</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-疑问"><span class="toc-text">5. 疑问</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">iMine</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/iMine141" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">73</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">9</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">24</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://github.com/iMine141" target="_blank" rel="noopener">iMine</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">iMineのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">fastjson和jackson冲突造成的数据解析问题</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-14</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/pulsar/">pulsar</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.8k</span><span class="post-meta__separator">|</span><span>Reading time: 24 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="1-版本"><a href="#1-版本" class="headerlink" title="1. 版本"></a>1. 版本</h1><p>pulsar：2.8.0</p>
<p>fastjson：1.2.76</p>
<h1 id="2-问题"><a href="#2-问题" class="headerlink" title="2. 问题"></a>2. 问题</h1><p>在pulsar项目中引入fastjson后，pulsar中某些admin api不能正常使用，会报NPE错误。</p>
<p>执行命令会报错：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[clooker bin]$ .&#x2F;pulsar-admin namespaces set-backlog-quota --limit 100M --limitTime 1111 --policy producer_request_hold sample&#x2F;ns118:38:54.968 [AsyncHttpClient-7-1] WARN  org.apache.pulsar.client.admin.internal.BaseResource - [http:&#x2F;&#x2F;x.x.x.x:8080&#x2F;admin&#x2F;v2&#x2F;namespaces&#x2F;sample&#x2F;ns1&#x2F;backlogQuota] Failed to perform http post request: javax.ws.rs.InternalServerErrorException: HTTP 500 Internal Server ErrorHTTP 500 Internal Server Error</span><br><span class="line">Reason: HTTP 500 Internal Server Error[clooker bin]$</span><br></pre></td></tr></table></figure>

<p>查看pulsar的日志：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">11:50:05.098 [pulsar-web-63-6] ERROR org.apache.pulsar.broker.admin.impl.NamespacesBase - [null] Failed to update backlog quota map for namespace sample&#x2F;ns1org.apache.pulsar.metadata.api.MetadataStoreException: com.fasterxml.jackson.databind.JsonMappingException: (was java.lang.NullPointerException) (through reference chain: org.apache.pulsar.common.policies.data.Policies[&quot;backlog_quota_map&quot;]-&gt;java.util.LinkedHashMap[&quot;destination_storage&quot;]-&gt;com.sun.proxy.$Proxy117[&quot;limitSize&quot;])  at org.apache.pulsar.broker.resources.BaseResources.set(BaseResources.java:94) ~[org.apache.pulsar-pulsar-broker-common-2.8.0.jar:2.8.0]  at org.apache.pulsar.broker.admin.impl.NamespacesBase.internalSetBacklogQuota(NamespacesBase.java:1387) ~[pulsar-broker-2.8.0.jar:2.8.0]  at org.apache.pulsar.broker.admin.v2.Namespaces.setBacklogQuota(Namespaces.java:724) ~[pulsar-broker-2.8.0.jar:2.8.0]  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_231]  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_231]  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_231]  at java.lang.reflect.Method.invoke(Method.java:498) ~[?:1.8.0_231]  at org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:52) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:124) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:167) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$VoidOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:159) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:79) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:475) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:397) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:81) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:255) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.internal.Errors$1.call(Errors.java:248) ~[org.glassfish.jersey.core-jersey-common-2.34.jar:?]  at org.glassfish.jersey.internal.Errors$1.call(Errors.java:244) ~[org.glassfish.jersey.core-jersey-common-2.34.jar:?]  at org.glassfish.jersey.internal.Errors.process(Errors.java:292) ~[org.glassfish.jersey.core-jersey-common-2.34.jar:?]  at org.glassfish.jersey.internal.Errors.process(Errors.java:274) ~[org.glassfish.jersey.core-jersey-common-2.34.jar:?]  at org.glassfish.jersey.internal.Errors.process(Errors.java:244) ~[org.glassfish.jersey.core-jersey-common-2.34.jar:?]  at org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:265) ~[org.glassfish.jersey.core-jersey-common-2.34.jar:?]  at org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:234) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:680) ~[org.glassfish.jersey.core-jersey-server-2.34.jar:?]  at org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:394) ~[org.glassfish.jersey.containers-jersey-container-servlet-core-2.34.jar:?]  at org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:346) ~[org.glassfish.jersey.containers-jersey-container-servlet-core-2.34.jar:?]  at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:366) ~[org.glassfish.jersey.containers-jersey-container-servlet-core-2.34.jar:?]  at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:319) ~[org.glassfish.jersey.containers-jersey-container-servlet-core-2.34.jar:?]  at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:205) ~[org.glassfish.jersey.containers-jersey-container-servlet-core-2.34.jar:?]  at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:799) ~[org.eclipse.jetty-jetty-servlet-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.servlet.ServletHandler$ChainEnd.doFilter(ServletHandler.java:1626) ~[org.eclipse.jetty-jetty-servlet-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.apache.pulsar.broker.web.ResponseHandlerFilter.doFilter(ResponseHandlerFilter.java:65) ~[pulsar-broker-2.8.0.jar:2.8.0]  at org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193) ~[org.eclipse.jetty-jetty-servlet-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1601) ~[org.eclipse.jetty-jetty-servlet-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:548) ~[org.eclipse.jetty-jetty-servlet-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1624) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1435) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:188) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:501) ~[org.eclipse.jetty-jetty-servlet-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1594) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:186) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1350) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:234) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:146) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:179) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.Server.handle(Server.java:516) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.HttpChannel.lambda$handle$1(HttpChannel.java:388) ~[org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:633) [org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:380) [org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:277) [org.eclipse.jetty-jetty-server-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:311) [org.eclipse.jetty-jetty-io-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:105) [org.eclipse.jetty-jetty-io-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.io.ChannelEndPoint$1.run(ChannelEndPoint.java:104) [org.eclipse.jetty-jetty-io-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:338) [org.eclipse.jetty-jetty-util-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:315) [org.eclipse.jetty-jetty-util-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:173) [org.eclipse.jetty-jetty-util-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131) [org.eclipse.jetty-jetty-util-9.4.42.v20210604.jar:9.4.42.v20210604]  at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:383) [org.eclipse.jetty-jetty-util-9.4.42.v20210604.jar:9.4.42.v20210604]  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_231]  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_231]  at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [io.netty-netty-common-4.1.63.Final.jar:4.1.63.Final]  at java.lang.Thread.run(Thread.java:748) [?:1.8.0_231]</span><br></pre></td></tr></table></figure>

<p>虽然能明显看出来是json解析报错引起的空指针问题，但是不知道是哪一个步骤造成解析失败。</p>
<h1 id="3-问题解决"><a href="#3-问题解决" class="headerlink" title="3. 问题解决"></a>3. 问题解决</h1><p>经过一系列的排查后，发现是fastjson自动注册provider引起的。</p>
<p>pulsar使用jersey框架作为restful接口的处理，同时使用jackson作为json解析框架，但是项目引入fastjson后，解析框架就会被替换成fast接送。</p>
<p>所以解决方法就是找到注册相关的代码，设置不自动注册。</p>
<p>查看fastjson中注册的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 这里继承jersey的AutoDiscoverable接口，并设置注册优先权高于jersey的默认权限，是为了优先注册fastjson的解析框架。</span></span><br><span class="line"><span class="meta">@Priority</span>(AutoDiscoverable.DEFAULT_PRIORITY - <span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastJsonAutoDiscoverable</span> <span class="keyword">implements</span> <span class="title">AutoDiscoverable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FASTJSON_AUTO_DISCOVERABLE = <span class="string">"fastjson.auto.discoverable"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> autoDiscover = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;        </span><br><span class="line">      <span class="comment">// 获取系统属性        </span></span><br><span class="line">      <span class="keyword">try</span> &#123;            </span><br><span class="line">        autoDiscover = Boolean.parseBoolean(System.getProperty(FASTJSON_AUTO_DISCOVERABLE, String.valueOf(autoDiscover)));        </span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="comment">//skip        </span></span><br><span class="line">      &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(<span class="keyword">final</span> FeatureContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Configuration config = context.getConfiguration();</span><br><span class="line">        <span class="comment">// Register FastJson. 如果设置了自动注册，且还没有注册过，则进行注册。        </span></span><br><span class="line">      <span class="keyword">if</span> (!config.isRegistered(FastJsonFeature<span class="class">.<span class="keyword">class</span>) &amp;&amp; <span class="title">autoDiscover</span>) </span>&#123;</span><br><span class="line">            context.register(FastJsonFeature<span class="class">.<span class="keyword">class</span>)</span>;        </span><br><span class="line">      &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>所以如果不想用fastjson，则需要设置自动注册为false：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">System.setProperty(FastJsonAutoDiscoverable.FASTJSON_AUTO_DISCOVERABLE, &quot;false&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>这个是全局变量，所以需要在程序启动的时候设置，如果在jersey加载完之后在设置就没有效果了。</strong></p>
<h1 id="4-问题排查"><a href="#4-问题排查" class="headerlink" title="4. 问题排查"></a>4. 问题排查</h1><p>解决办法虽然很简单，一行代码就可以了，但是找问题却耗费了很长时间，下面记录下查找问题做的一些工作。</p>
<h2 id="4-1-问题确认"><a href="#4-1-问题确认" class="headerlink" title="4.1 问题确认"></a>4.1 问题确认</h2><p>出现问题的原因是我们添加了自己的业务逻辑，那么就要确认这个问题是新增代码引起的还是以前就有的bug。</p>
<p>所以首先需要把环境恢复成修改之前的环境，然后测试。</p>
<p>结果发现之前的环境没问题，所以确认出现问题的原因就是最近新加的代码。</p>
<h2 id="4-2-在问题出现的地方找原因"><a href="#4-2-在问题出现的地方找原因" class="headerlink" title="4.2 在问题出现的地方找原因"></a>4.2 在问题出现的地方找原因</h2><p>通常情况下，对于新出现的问题，我们不可能马上明白原因是啥，不知道是之前哪一块逻辑修改造成的，尤其是代码可能不是自己写的。</p>
<p>所以，最简单的就是在问题出现地方的前后打日志，理清前后逻辑。</p>
<p>该问题出现在</p>
<p>org.apache.pulsar.metadata.cache.impl.MetadataCacheImpl：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title">readModifyUpdate</span><span class="params">(String path, Function&lt;T, T&gt; modifyFunction)</span> </span>&#123;</span><br><span class="line">  log.info(<span class="string">"vvv method &#123;&#125;, path &#123;&#125;"</span>, <span class="string">"readModifyUpdate0"</span>, path);</span><br><span class="line">  <span class="keyword">return</span> executeWithRetry(() -&gt; objCache.get(path)</span><br><span class="line">      .thenCompose(optEntry -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!optEntry.isPresent()) &#123;</span><br><span class="line">          <span class="keyword">return</span> FutureUtils.exception(<span class="keyword">new</span> NotFoundException(<span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CacheGetResult&lt;T&gt; entry = optEntry.get();</span><br><span class="line">        T currentValue = entry.getValue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> expectedVersion = optEntry.get().getStat().getVersion();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"vvv method &#123;&#125;, path: &#123;&#125;, class: &#123;&#125;, value: &#123;&#125;, hash: &#123;&#125;, expectedVersion: &#123;&#125;, p: &#123;&#125;"</span>,</span><br><span class="line">            <span class="string">"readModifyUpdate"</span>, path, currentValue.getClass(), currentValue, currentValue.hashCode(),</span><br><span class="line">            expectedVersion, <span class="keyword">this</span>.hashCode());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentValue <span class="keyword">instanceof</span> Policies) &#123;</span><br><span class="line">          Policies p = (Policies) currentValue;</span><br><span class="line">          <span class="keyword">if</span> (p.backlog_quota_map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            p.backlog_quota_map.forEach((key, value) -&gt; &#123;</span><br><span class="line">              log.info(<span class="string">"vvv method &#123;&#125;, path &#123;&#125;, key &#123;&#125;, value &#123;&#125; &#123;&#125;"</span>, <span class="string">"readModifyUpdate"</span>, path, key,</span><br><span class="line">                  value.getClass(), value);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        T newValueObj;</span><br><span class="line">        <span class="keyword">byte</span>[] newValue;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// Use clone and CAS zk to ensure thread safety</span></span><br><span class="line">                    <span class="comment">// 问题出现在这里</span></span><br><span class="line">          currentValue = serde.deserialize(serde.serialize(currentValue));</span><br><span class="line">                    <span class="comment">// apply方法可以拿到之前方法的值。</span></span><br><span class="line">          newValueObj = modifyFunction.apply(currentValue);</span><br><span class="line">          log.info(<span class="string">"vvv method &#123;&#125;, path: &#123;&#125;, class: &#123;&#125;, newValue: &#123;&#125;"</span>, <span class="string">"readModifyUpdate"</span>, path,</span><br><span class="line">              newValueObj.getClass(), newValueObj);</span><br><span class="line"></span><br><span class="line">          newValue = serde.serialize(newValueObj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          <span class="keyword">return</span> FutureUtils.exception(t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> store.put(path, newValue, Optional.of(expectedVersion)).thenAccept(stat -&gt; &#123;</span><br><span class="line">          <span class="comment">// Make sure we have the value cached before the operation is completed</span></span><br><span class="line">          log.info(<span class="string">"vvv method &#123;&#125;, path &#123;&#125;"</span>, <span class="string">"readModifyUpdate-put"</span>, path);</span><br><span class="line">          objCache.put(path,</span><br><span class="line">              FutureUtils.value(Optional.of(<span class="keyword">new</span> CacheGetResult&lt;&gt;(newValueObj, stat))));</span><br><span class="line">        &#125;).thenApply(__ -&gt; newValueObj);</span><br><span class="line">      &#125;), path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过阅读该类的代码，可以发现：</p>
<ul>
<li><p>该类缓存了一些从zookeeper中查询的数据，缓存使用的框架是Caffeine。</p>
</li>
<li><p>缓存中的数据会定时老化。</p>
</li>
<li><p>该类提供了数据修改方法，接收到修改指令后会更新到zookeeper中，然后更新缓存数据。</p>
</li>
<li><p>在上述方法中，接收到更新指令后，首先根据path查找缓存中是否存在，如果不存在则直接返回；如果存在，则获取数据和数据版本（对应zookeeper中的版本），把旧数据序列化后再反序列化（不知道意义是啥），然后把新数据保存到zookeeper中，保存成功后更新缓存数据。</p>
</li>
<li><p>缓存初始化的方法是readValueFromStore用于从zookeeper中查询数据。</p>
</li>
</ul>
<p><strong>打包后替换线上环境，并看下打印的日志：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">11:50:05.095 [pulsar-web-63-6] INFO  org.apache.pulsar.metadata.cache.impl.MetadataCacheImpl - vvv method readModifyUpdate, path: &#x2F;admin&#x2F;policies&#x2F;sample&#x2F;ns1, class: class org.apache.pulsar.common.policies.data.Policies, value: Policies(auth_policies&#x3D;AuthPoliciesImpl(namespaceAuthentication&#x3D;&#123;&#125;, topicAuthentication&#x3D;&#123;&#125;, subscriptionAuthentication&#x3D;&#123;&#125;), replication_clusters&#x3D;[standalone], bundles&#x3D;BundlesDataImpl(boundaries&#x3D;[0x00000000, 0x40000000, 0x80000000, 0xc0000000, 0xffffffff], numBundles&#x3D;4), backlog_quota_map&#x3D;&#123;destination_storage&#x3D;&#123;&#125;&#125;, clusterDispatchRate&#x3D;&#123;&#125;, topicDispatchRate&#x3D;&#123;&#125;, subscriptionDispatchRate&#x3D;&#123;&#125;, replicatorDispatchRate&#x3D;&#123;&#125;, clusterSubscribeRate&#x3D;&#123;&#125;, persistence&#x3D;null, deduplicationEnabled&#x3D;null, autoTopicCreationOverride&#x3D;null, autoSubscriptionCreationOverride&#x3D;null, publishMaxMessageRate&#x3D;&#123;&#125;, latency_stats_sample_rate&#x3D;&#123;&#125;, message_ttl_in_seconds&#x3D;null, subscription_expiration_time_minutes&#x3D;0, retention_policies&#x3D;null, deleted&#x3D;false, encryption_required&#x3D;false, delayed_delivery_policies&#x3D;null, inactive_topic_policies&#x3D;null, subscription_auth_mode&#x3D;None, max_producers_per_topic&#x3D;null, max_consumers_per_topic&#x3D;null, max_consumers_per_subscription&#x3D;null, max_unacked_messages_per_consumer&#x3D;null, max_unacked_messages_per_subscription&#x3D;null, max_subscriptions_per_topic&#x3D;null, compaction_threshold&#x3D;null, offload_threshold&#x3D;-1, offload_deletion_lag_ms&#x3D;null, max_topics_per_namespace&#x3D;null, schema_auto_update_compatibility_strategy&#x3D;Full, schema_compatibility_strategy&#x3D;UNDEFINED, is_allow_auto_update_schema&#x3D;true, schema_validation_enforced&#x3D;false, offload_policies&#x3D;null, deduplicationSnapshotIntervalSeconds&#x3D;null, subscription_types_enabled&#x3D;[], properties&#x3D;&#123;&#125;, resource_group_name&#x3D;null), hash: -2056889852, expectedVersion: 0, p: 1890262240</span><br></pre></td></tr></table></figure>

<p>可以看到backlog_quota_map={destination_storage={}}中destination_storage是一个空值，所以当序列化的时候会抛出NPE异常。</p>
<p>正常情况下的日志应该是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">10:49:44.719 [metadata-store-32-1] INFO  org.apache.pulsar.metadata.cache.impl.MetadataCacheImpl - vvv method readValueFromStore, path &#x2F;admin&#x2F;policies&#x2F;sample&#x2F;ns1, class class org.apache.pulsar.common.policies.data.Policies, value Policies(auth_policies&#x3D;AuthPoliciesImpl(namespaceAuthentication&#x3D;&#123;&#125;, topicAuthentication&#x3D;&#123;&#125;, subscriptionAuthentication&#x3D;&#123;&#125;), replication_clusters&#x3D;[standalone], bundles&#x3D;BundlesDataImpl(boundaries&#x3D;[0x00000000, 0x40000000, 0x80000000, 0xc0000000, 0xffffffff], numBundles&#x3D;4), backlog_quota_map&#x3D;&#123;destination_storage&#x3D;BacklogQuotaImpl(limitSize&#x3D;104857600, limitTime&#x3D;1111, policy&#x3D;producer_request_hold)&#125;, clusterDispatchRate&#x3D;&#123;&#125;, topicDispatchRate&#x3D;&#123;&#125;, subscriptionDispatchRate&#x3D;&#123;&#125;, replicatorDispatchRate&#x3D;&#123;&#125;, clusterSubscribeRate&#x3D;&#123;&#125;, persistence&#x3D;null, deduplicationEnabled&#x3D;null, autoTopicCreationOverride&#x3D;null, autoSubscriptionCreationOverride&#x3D;null, publishMaxMessageRate&#x3D;&#123;&#125;, latency_stats_sample_rate&#x3D;&#123;&#125;, message_ttl_in_seconds&#x3D;null, subscription_expiration_time_minutes&#x3D;0, retention_policies&#x3D;null, deleted&#x3D;false, encryption_required&#x3D;false, delayed_delivery_policies&#x3D;null, inactive_topic_policies&#x3D;null, subscription_auth_mode&#x3D;None, max_producers_per_topic&#x3D;null, max_consumers_per_topic&#x3D;null, max_consumers_per_subscription&#x3D;null, max_unacked_messages_per_consumer&#x3D;null, max_unacked_messages_per_subscription&#x3D;null, max_subscriptions_per_topic&#x3D;null, compaction_threshold&#x3D;null, offload_threshold&#x3D;-1, offload_deletion_lag_ms&#x3D;null, max_topics_per_namespace&#x3D;null, schema_auto_update_compatibility_strategy&#x3D;Full, schema_compatibility_strategy&#x3D;UNDEFINED, is_allow_auto_update_schema&#x3D;true, schema_validation_enforced&#x3D;false, offload_policies&#x3D;null, deduplicationSnapshotIntervalSeconds&#x3D;null, subscription_types_enabled&#x3D;[], properties&#x3D;&#123;&#125;, resource_group_name&#x3D;null), hash 1614905576, version: 1, p: 1843660571</span><br></pre></td></tr></table></figure>

<p>destination_storage是有内容的，内容是：</p>
<p>BacklogQuotaImpl(limitSize=104857600, limitTime=1111, policy=producer_request_hold)。</p>
<p>由于这里的数据是从缓存中获取的，所以怀疑从缓存中拿到数据就是空，但是在readValueFromStore方法中打印日志后，发现这里的数据并不是空，而且内容和readModifyUpdate中不一样。<strong>所以就能确认在其他地方修改了缓存中的数据</strong>。</p>
<h2 id="4-3-查看调用链"><a href="#4-3-查看调用链" class="headerlink" title="4.3 查看调用链"></a>4.3 查看调用链</h2><p>通过debug可以确认调用链是：</p>
<ul>
<li><p>org.apache.pursar.broker.admin.v2.Namespaces -&gt; setBacklogQuota</p>
</li>
<li><p>org.apache.pursar.broker.admin.impl.NamespaceBase -&gt; internalSetBacklogQuota</p>
</li>
<li><p>org.apache.pulsar.broker.resources -&gt; set</p>
</li>
<li><p>org.apache.pulsar.broker.resources -&gt; setAsync</p>
</li>
<li><p>org.apache.pulsar.metadata.cache.impl -&gt; readModifyUpdate</p>
</li>
</ul>
<p>第一个方法就是提供了http接口，接收客户端传递的参数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBacklogQuota</span><span class="params">(@PathParam(<span class="string">"tenant"</span>)</span> String tenant, @<span class="title">PathParam</span><span class="params">(<span class="string">"namespace"</span>)</span> String namespace,</span></span><br><span class="line"><span class="function">    @<span class="title">QueryParam</span><span class="params">(<span class="string">"backlogQuotaType"</span>)</span> BacklogQuotaType backlogQuotaType,</span></span><br><span class="line"><span class="function">    @<span class="title">ApiParam</span><span class="params">(value = <span class="string">"Backlog quota for all topics of the specified namespace"</span>)</span></span></span><br><span class="line"><span class="function">        BacklogQuota backlogQuota) </span>&#123;</span><br><span class="line">  validateNamespaceName(tenant, namespace);</span><br><span class="line">  log.info(<span class="string">"vvv method &#123;&#125;, backlogQuota &#123;&#125;, class &#123;&#125;"</span>, <span class="string">"setBacklogQuota"</span>, backlogQuota, backlogQuota.getClass());</span><br><span class="line">  internalSetBacklogQuota(backlogQuotaType, backlogQuota);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处打印的日志如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">11:50:05.094 [pulsar-web-63-6] INFO  org.apache.pulsar.broker.admin.v2.Namespaces - vvv method setBacklogQuota, backlogQuota &#123;&#125;, class com.sun.proxy.$Proxy117 &#123;&#125;</span><br></pre></td></tr></table></figure>





<p>第二个方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">internalSetBacklogQuota</span><span class="params">(BacklogQuotaType backlogQuotaType, BacklogQuota backlogQuota)</span> </span>&#123;</span><br><span class="line">  validateNamespacePolicyOperation(namespaceName, PolicyName.BACKLOG, PolicyOperation.WRITE);</span><br><span class="line">  validatePoliciesReadOnlyAccess();</span><br><span class="line">  <span class="keyword">final</span> BacklogQuotaType quotaType = backlogQuotaType != <span class="keyword">null</span> ? backlogQuotaType</span><br><span class="line">      : BacklogQuotaType.destination_storage;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> String path = path(POLICIES, namespaceName.toString());</span><br><span class="line">        <span class="comment">// 从MetaCacheImpl中获取缓存中的数据。</span></span><br><span class="line">    Policies policies = namespaceResources().get(path)</span><br><span class="line">        .orElseThrow(() -&gt; <span class="keyword">new</span> RestException(Status.NOT_FOUND, <span class="string">"Namespace policies does not exist"</span>));</span><br><span class="line">    RetentionPolicies r = policies.retention_policies;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Policies p = <span class="keyword">new</span> Policies();</span><br><span class="line">      p.backlog_quota_map.put(quotaType, backlogQuota);</span><br><span class="line">      <span class="keyword">if</span> (!checkQuotas(p, r)) &#123;</span><br><span class="line">        log.warn(</span><br><span class="line">            <span class="string">"[&#123;&#125;] Failed to update backlog configuration"</span></span><br><span class="line">                + <span class="string">" for namespace &#123;&#125;: conflicts with retention quota"</span>,</span><br><span class="line">            clientAppId(), namespaceName);</span><br><span class="line">        <span class="keyword">new</span> RestException(Status.PRECONDITION_FAILED,</span><br><span class="line">            <span class="string">"Backlog Quota exceeds configured retention quota for namespace."</span></span><br><span class="line">                + <span class="string">" Please increase retention quota and retry"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">// 修改缓存中的数据（这里是直接修改缓存中的数据，所以在之前的日志中,</span></span><br><span class="line">        <span class="comment">// 我们发现readModifyUpdate方法中拿到的缓存对象的内容和缓存加载方法readValueFromStore中的不一致）。</span></span><br><span class="line">    policies.backlog_quota_map.put(quotaType, backlogQuota);</span><br><span class="line">    log.info(<span class="string">"vvv method &#123;&#125;, path &#123;&#125;, policies &#123;&#125;"</span>, <span class="string">"internalSetBacklogQuota"</span>, path, policies);</span><br><span class="line">    namespaceResources().set(path, p -&gt; policies);</span><br><span class="line">    log.info(<span class="string">"[&#123;&#125;] Successfully updated backlog quota map: namespace=&#123;&#125;, map=&#123;&#125;"</span>, clientAppId(), namespaceName,</span><br><span class="line">        jsonMapper().writeValueAsString(backlogQuota));</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (RestException pfe) &#123;</span><br><span class="line">    <span class="keyword">throw</span> pfe;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">"[&#123;&#125;] Failed to update backlog quota map for namespace &#123;&#125;"</span>, clientAppId(), namespaceName, e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RestException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法中，先是从MetaCacheImple对象中根据path拿到缓存中的policies，然后更新该policies，然后再通过MetaCacheImpl的update方法更新zookeeper中的数据。</p>
<p><strong>通过上述流程，我们可以确定的是，缓存从zookeeper中加载的数据是正确的，客户端调用命令后传递的数据是错误的，所以定位到问题出现在调用链的第一个方法中。</strong></p>
<h2 id="4-4-问题分析"><a href="#4-4-问题分析" class="headerlink" title="4.4 问题分析"></a>4.4 问题分析</h2><p>从前面的过程中，我们就能大致确认问题是客户端传递的参数没有被正常解析或者客户端传递的参数为空，然后pulsar本身使用jersey作为restful框架，使用jackson解析请求中的json数据，并对请求参数进行赋值。</p>
<p>首先通过tcpdump捕获交互过程中的数据包，确定客户端发送的数据中是有内容的：</p>
<p><img src="assets/image-20231007103138364.png" alt="image-20231007103138364"></p>
<p>可以看到传递的内容不为空，然后看不报错情况下的数据报文：</p>
<p><img src="assets/image-20231007103221655.png" alt="image-20231007103221655"></p>
<p>由此就可以确定不是客户端的问题，而是broker端接收到数据后的解析问题。</p>
<p>结合以往经验，推测是不同的json处理框架有冲突，导致数据解析失败。把fastjson去掉后，果然问题不再出现！</p>
<h2 id="4-5-问题解决"><a href="#4-5-问题解决" class="headerlink" title="4.5 问题解决"></a>4.5 问题解决</h2><p>既然是fastjson的问题，那么推测是加载fastjson包后，会在某些情况下替换jackson进行json数据的解析，导致解析出错。</p>
<p>pulsar是基于jersey作为restful框架的，而jersey遵循了javax-ws规范，规范中定义了加载哪些数据解析类，即定义了加载哪一个json框架作为解析框架。</p>
<p>搜索关键词：fastjson和jersey冲突，发现fastjson项目中的一个issue：</p>
<p><a href="https://github.com/alibaba/fastjson/issues/1392" target="_blank" rel="noopener">https://github.com/alibaba/fastjson/issues/1392</a></p>
<p>有人遇到了相似的问题，fastjson进行了修复。</p>
<p>我们的问题与上述问题还是有些不同的，但本质一样，都是由于fastjson默认加载了自己的作为java-ws的provider，导致jersey不能加载jackson。</p>
<p>而fastjson又不够强大，如果参数中的变量类型是interface，fastjson不能找到该interface的实现类并赋值，所以我们看到setBacklogQuota方法中backlogQuota是空的，而且class是com.sun.proxy.$Proxy117。</p>
<p><strong>如果我们把BacklogQuota换成backlogQuotaImpl或者我们自己写的一个包含三个参数的类，则能成功赋值，例如这样：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VVData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> limitSize;</span><br><span class="line">    <span class="comment">// backlog quota by time in second</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> limitTime;</span><br><span class="line">    <span class="keyword">private</span> BacklogQuota.RetentionPolicy policy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">12:14:01.371 [pulsar-web-63-12] INFO  org.apache.pulsar.broker.admin.v2.Namespaces - vvv method setBacklogQuota, backlogQuota VVData(limitSize&#x3D;104857600, limitTime&#x3D;1111, policy&#x3D;producer_request_hold</span><br></pre></td></tr></table></figure>

<h1 id="5-疑问"><a href="#5-疑问" class="headerlink" title="5. 疑问"></a>5. 疑问</h1><p>上边问题已经解决了，但是在找问题的过程中，发现可以通过其他地方修改Caffeine缓存中的数据。</p>
<p><strong>这里在多线程同时操作情况下有出现数据不一致的问题吧</strong></p>
<p>fastjson不会自动把自己设置为java-ws的provider，应该是jersey在启动的时候查找AutoDiscoverable接口的所有实现类，然后根据实现类里面设置的优先级加载优先级最高的provider，或者按照优先级顺序加载所有的provider。AutoDiscoverable的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package org.glassfish.jersey.internal.spi;</span><br><span class="line">import javax.ws.rs.core.FeatureContext;</span><br><span class="line">&#x2F;** * A service provider contract for JAX-RS and Jersey components that need to be automatically discovered and registered in * &#123;@link javax.ws.rs.core.Configuration runtime configurations&#125;. * &lt;p&#x2F;&gt; * A component implementing this contract becomes auto-discoverable by adding a new entry with fully qualified name of its * implementation class name to a &#123;@code org.glassfish.jersey.internal.spi.AutoDiscoverable&#125; file in the &#123;@code * META-INF&#x2F;services&#125; directory. * &lt;p&#x2F;&gt; * Almost all Jersey &#123;@code AutoDiscoverable&#125; implementations have * &#123;@link #DEFAULT_PRIORITY&#125; &#123;@link javax.annotation.Priority priority&#125; set. * * @author Michal Gajdos *&#x2F;public interface AutoDiscoverable &#123;</span><br><span class="line">    &#x2F;**     * Default common priority of Jersey build-in auto-discoverables.     * Use lower number on your &#123;@code AutoDiscoverable&#125; implementation to run it before Jersey auto-discoverables     * and vice versa.     * 优先级，在fastjson中设置的优先级是 (DEFAULT_PRIORITY - 1)，所以会优先加载。     *&#x2F;    public static final int DEFAULT_PRIORITY &#x3D; 2000;</span><br><span class="line">    &#x2F;**     * A call-back method called when an auto-discoverable component is to be configured in a given runtime configuration scope.     * &lt;p&gt;     * Note that as with &#123;@link javax.ws.rs.core.Feature JAX-RS features&#125;, before registering new JAX-RS components in a     * given configurable context, an auto-discoverable component should verify that newly registered components are not     * already registered in the configurable context.     * &lt;&#x2F;p&gt;     *     * @param context configurable context in which the auto-discoverable should be configured.     *&#x2F;    public void configure(FeatureContext context);&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">iMine</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://imine141.github.io/2021/09/14/pulsar/%E3%80%90bug%E3%80%91fastjson%E5%92%8Cjackson%E5%86%B2%E7%AA%81%E9%80%A0%E6%88%90%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90%E9%97%AE%E9%A2%98/">https://imine141.github.io/2021/09/14/pulsar/%E3%80%90bug%E3%80%91fastjson%E5%92%8Cjackson%E5%86%B2%E7%AA%81%E9%80%A0%E6%88%90%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90%E9%97%AE%E9%A2%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pulsar/">pulsar</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/10/15/pulsar/Pulsar%E8%AE%A2%E9%98%85%E8%BF%9B%E5%BA%A6%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86/"><i class="fa fa-chevron-left">  </i><span>Pulsar订阅进度同步原理</span></a></div><div class="next-post pull-right"><a href="/2021/09/02/pulsar/%E5%8F%AA%E8%AF%BBbroker%E8%AE%BE%E8%AE%A1%EF%BC%88%E4%B8%80%EF%BC%89/"><span>只读broker设计（一）</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '316d899c68e414a53017',
  clientSecret: 'e63edfd4dd96b3b665a0a561e2ce048c2b3f0a3b',
  repo: 'imine141.github.io',
  owner: 'imine141',
  admin: 'imine141',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2023 By iMine</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>