<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="pulsar消息读流程（一"><meta name="keywords" content="pulsar"><meta name="author" content="iMine"><meta name="copyright" content="iMine"><title>pulsar消息读流程（一 | iMineのBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?434d6055a3a5266f2c2a21749e588070";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-consumer端的处理流程"><span class="toc-text">1. consumer端的处理流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-broker端的处理流程"><span class="toc-text">2. broker端的处理流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-zookeeper中存储的信息"><span class="toc-text">2.1 zookeeper中存储的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-ManagedLedgerInfo和ManagedCursorInfo结构"><span class="toc-text">2.2 ManagedLedgerInfo和ManagedCursorInfo结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-判断topic是属于哪一个broker"><span class="toc-text">2.3 判断topic是属于哪一个broker</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-总结"><span class="toc-text">3. 总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">iMine</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/iMine141" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">74</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">9</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">24</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://github.com/iMine141" target="_blank" rel="noopener">iMine</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">iMineのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">pulsar消息读流程（一</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-09</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/pulsar/">pulsar</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.1k</span><span class="post-meta__separator">|</span><span>Reading time: 11 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>大致介绍下pulsar的消息读的过程</p>
<p>consumer通过lookup命令查找到负责消费topic的broker地址，然后连接到该broker。broker接收到请求后，首先查找内存中有没有该订阅名称的consumer信息，如果有，则找到对应的subscription信息，然后建立和consumer的关系。之后从zk和bk中获取消息处理的ledger和对应的cursor。</p>
<p>然后consumer可以定时发送通知（sendFlowPermitsToBroker），broker接收到通知后就从ledger读消息返回给consumer。消息的发送是异步的，在handleFlow中处理consumer的通知，然后读取数据，读取完成后就发送给consumer。</p>
<h1 id="1-consumer端的处理流程"><a href="#1-consumer端的处理流程" class="headerlink" title="1. consumer端的处理流程"></a>1. consumer端的处理流程</h1><p>consumer的创建代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Consumer&lt;String&gt; c &#x3D; client.newConsumer(Schema.STRING)</span><br><span class="line">    .topic(topic)</span><br><span class="line">    .subscriptionName(&quot;subscription_001&quot;)</span><br><span class="line">    .receiverQueueSize(4)</span><br><span class="line">    .subscribe();</span><br><span class="line">Message&lt;String&gt; msg &#x3D; c.receive(5, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p>在subscribe后，会创建一个consumer对象，然后调用该对象的receive方法获取消息。</p>
<p><strong>ConsumerBase</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Message&lt;T&gt; receive(int timeout, TimeUnit unit) throws PulsarClientException &#123;</span><br><span class="line">    if (conf.getReceiverQueueSize() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        throw new PulsarClientException.InvalidConfigurationException(</span><br><span class="line">            &quot;Can&#39;t use receive with timeout, if the queue size is 0&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (listener !&#x3D; null) &#123;</span><br><span class="line">        throw new PulsarClientException.InvalidConfigurationException(</span><br><span class="line">            &quot;Cannot use receive() when a listener has been set&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    verifyConsumerState();</span><br><span class="line">    return internalReceive(timeout, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ConsumerImpl</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Message&lt;T&gt; <span class="title">internalReceive</span><span class="params">(<span class="keyword">int</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> PulsarClientException </span>&#123;</span><br><span class="line">    Message&lt;T&gt; message;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 先从缓存队列中获取，如果获取不到则直接返回。</span></span><br><span class="line">        message = incomingMessages.poll(timeout, unit);</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 暂时不返回消息，而是给broker发送通知，表示自己可以接收更多的消息了。</span></span><br><span class="line">        messageProcessed(message);</span><br><span class="line">        <span class="keyword">return</span> beforeConsume(message);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        State state = getState();</span><br><span class="line">        <span class="keyword">if</span> (state != State.Closing &amp;&amp; state != State.Closed) &#123;</span><br><span class="line">            stats.incrementNumReceiveFailed();</span><br><span class="line">            <span class="keyword">throw</span> PulsarClientException.unwrap(e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">messageProcessed</span><span class="params">(Message&lt;?&gt; msg)</span> </span>&#123;</span><br><span class="line">    ClientCnx currentCnx = cnx();</span><br><span class="line">    ClientCnx msgCnx = ((MessageImpl&lt;?&gt;) msg).getCnx();</span><br><span class="line">    lastDequeuedMessageId = msg.getMessageId();</span><br><span class="line">    <span class="keyword">if</span> (msgCnx != currentCnx) &#123;</span><br><span class="line">        <span class="comment">// The processed message did belong to the old queue that was cleared after reconnection.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        increaseAvailablePermits(currentCnx);</span><br><span class="line">        stats.updateNumMsgsReceived(msg);</span><br><span class="line">        trackMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    decreaseIncomingMessageSize(msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">increaseAvailablePermits</span><span class="params">(ClientCnx currentCnx)</span> </span>&#123;</span><br><span class="line">    increaseAvailablePermits(currentCnx, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">increaseAvailablePermits</span><span class="params">(ClientCnx currentCnx, <span class="keyword">int</span> delta)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> available = AVAILABLE_PERMITS_UPDATER.addAndGet(<span class="keyword">this</span>, delta);</span><br><span class="line">    <span class="keyword">while</span> (available &gt;= receiverQueueRefillThreshold &amp;&amp; !paused) &#123;</span><br><span class="line">        <span class="comment">// 确保能发送一次通知</span></span><br><span class="line">        <span class="keyword">if</span> (AVAILABLE_PERMITS_UPDATER.compareAndSet(<span class="keyword">this</span>, available, <span class="number">0</span>)) &#123;</span><br><span class="line">            sendFlowPermitsToBroker(currentCnx, available);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            available = AVAILABLE_PERMITS_UPDATER.get(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * send the flow command to have the broker start pushing messages</span></span><br><span class="line"><span class="comment"> * 发送flow通知给broker，异步获取更多消息。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendFlowPermitsToBroker</span><span class="params">(ClientCnx cnx, <span class="keyword">int</span> numMessages)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cnx != <span class="keyword">null</span> &amp;&amp; numMessages &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"[&#123;&#125;] [&#123;&#125;] Adding &#123;&#125; additional permits"</span>, topic, subscription, numMessages);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            cnx.ctx().writeAndFlush(Commands.newFlow(consumerId, numMessages))</span><br><span class="line">                .addListener(writeFuture -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!writeFuture.isSuccess()) &#123;</span><br><span class="line">                        log.debug(<span class="string">"Consumer &#123;&#125; failed to send &#123;&#125; permits to broker: &#123;&#125;"</span>, consumerId, numMessages,</span><br><span class="line">                                  writeFuture.cause().getMessage());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.debug(<span class="string">"Consumer &#123;&#125; sent &#123;&#125; permits to broker"</span>, consumerId, numMessages);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cnx.ctx().writeAndFlush(Commands.newFlow(consumerId, numMessages), cnx.ctx().voidPromise());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="2-broker端的处理流程"><a href="#2-broker端的处理流程" class="headerlink" title="2. broker端的处理流程"></a>2. broker端的处理流程</h1><p>和consumer交互的主要是ServerCnx中的handleConnect、handleSubscribe、handleFlow、handleAck四个方法，connect中处理认证信息，subscribe中获取订阅名称，保存订阅关系，flow中接收消息接收通知，触发从ledger中读取消息，ack中处理消息消费确认信息。</p>
<p>在broker中，每一个topic对应一个处理实例（PersistentTopic或者NonPersistentTopic），这个实例中保存topic信息和相关订阅信息（subscriptions）。</p>
<p>subscription本身是一个map变量，以SubscriptionName作为key，保存详细的订阅信息（即每一个订阅名称的所有客户端共享一组订阅信息，用于处理消息订阅的四种类型）。</p>
<p>在Subscription中有一个dispatcher变量，该变量直接存储所有的consumer信息。</p>
<p>所以，上述信息的存储关系链是：</p>
<p>topic -&gt; subscription -&gt; dispatcher -&gt; consumer</p>
<h2 id="2-1-zookeeper中存储的信息"><a href="#2-1-zookeeper中存储的信息" class="headerlink" title="2.1 zookeeper中存储的信息"></a>2.1 zookeeper中存储的信息</h2><p>消息订阅信息保存在zookeeper中的/managed_ledgers路径下，其中有两个重要的信息：ledger信息和cursor信息。</p>
<p>ledger存储topic消息在bk中的信息，cursor存储消费者读取进度，在zk中的路径分别是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;managed_ledgers&#x2F;&#123;tenant&#125;&#x2F;&#123;namespace&#125;&#x2F;persistent&#x2F;&#123;topic&#125;</span><br><span class="line">&#x2F;managed_ledgers&#x2F;&#123;tenant&#125;&#x2F;&#123;namespace&#125;&#x2F;persistent&#x2F;&#123;topic&#125;&#x2F;&#123;subscription_name&#125;</span><br></pre></td></tr></table></figure>



<p>在zk中的这部分信息可以直接解析出来，测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testZKMetaData</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String path = <span class="string">"/managed-ledgers/tenant_c/ns1/persistent/topic_name"</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = getValue(path);</span><br><span class="line">    <span class="keyword">if</span> (bytes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"bytes is null"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    MLDataFormats.ManagedLedgerInfo info = MLDataFormats.ManagedLedgerInfo.parseFrom(bytes);</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (MLDataFormats.ManagedLedgerInfo.LedgerInfo ls : info.getLedgerInfoList()) &#123;</span><br><span class="line">        sb.setLength(<span class="number">0</span>);</span><br><span class="line">        sb.append(<span class="string">"ledgerId="</span>).append(ls.getLedgerId());</span><br><span class="line">        sb.append(<span class="string">", entries="</span>).append(ls.getEntries());</span><br><span class="line">        sb.append(<span class="string">", size="</span>).append(ls.getSize());</span><br><span class="line">        sb.append(<span class="string">", timestamp="</span>).append(ls.getTimestamp());</span><br><span class="line">        System.out.println(<span class="string">"debug vv "</span> + sb);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"done"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testZKMetaDataCursorInfo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String path = <span class="string">"/managed-ledgers/tenant_c/ns1/persistent/topic_name/subscription_name_0"</span>;</span><br><span class="line">    path = <span class="string">"/managed-ledgers/tenant_c/ns1/persistent/topic_name/subscription_name_1"</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = getValue(path);</span><br><span class="line">    <span class="keyword">if</span> (bytes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"bytes is null"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    MLDataFormats.ManagedCursorInfo info = MLDataFormats.ManagedCursorInfo.parseFrom(bytes);</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    sb.setLength(<span class="number">0</span>);</span><br><span class="line">    sb.append(<span class="string">"markDeleteLedgerId="</span>).append(info.getMarkDeleteLedgerId());</span><br><span class="line">    sb.append(<span class="string">", markDeleteEntryId="</span>).append(info.getMarkDeleteEntryId());</span><br><span class="line">    sb.append(<span class="string">", lastActive="</span>).append(info.getLastActive());</span><br><span class="line">    System.out.println(<span class="string">"debug vv "</span> + sb);</span><br><span class="line">    System.out.println(<span class="string">"done"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">byte</span>[] getValue(String path) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">    ZooKeeper zoo = <span class="keyword">new</span> ZooKeeper(<span class="string">"x.x.x.x:2181"</span>, <span class="number">10000</span>, <span class="keyword">new</span> Watcher() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (event.getState() == Event.KeeperState.SyncConnected) &#123;</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"state "</span> + event.getState());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    latch.await();</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = zoo.getData(path, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    zoo.close();</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>testZKMetaData输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">debug vv ledgerId&#x3D;56929, entries&#x3D;10, size&#x3D;710, timestamp&#x3D;1628234384802</span><br><span class="line">debug vv ledgerId&#x3D;56933, entries&#x3D;10, size&#x3D;720, timestamp&#x3D;1628235295486</span><br><span class="line">debug vv ledgerId&#x3D;56937, entries&#x3D;10, size&#x3D;710, timestamp&#x3D;1628240968389</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">debug vv markDeleteLedgerId&#x3D;56933, markDeleteEntryId&#x3D;9, lastActive&#x3D;1628236717415</span><br><span class="line">debug vv markDeleteLedgerId&#x3D;56937, markDeleteEntryId&#x3D;2, lastActive&#x3D;1628240766897</span><br></pre></td></tr></table></figure>

<h2 id="2-2-ManagedLedgerInfo和ManagedCursorInfo结构"><a href="#2-2-ManagedLedgerInfo和ManagedCursorInfo结构" class="headerlink" title="2.2 ManagedLedgerInfo和ManagedCursorInfo结构"></a>2.2 ManagedLedgerInfo和ManagedCursorInfo结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Licensed to the Apache Software Foundation (ASF) under one</span><br><span class="line"> * or more contributor license agreements.  See the NOTICE file</span><br><span class="line"> * distributed with this work for additional information</span><br><span class="line"> * regarding copyright ownership.  The ASF licenses this file</span><br><span class="line"> * to you under the Apache License, Version 2.0 (the</span><br><span class="line"> * &quot;License&quot;); you may not use this file except in compliance</span><br><span class="line"> * with the License.  You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *   http:&#x2F;&#x2F;www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing,</span><br><span class="line"> * software distributed under the License is distributed on an</span><br><span class="line"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span><br><span class="line"> * KIND, either express or implied.  See the License for the</span><br><span class="line"> * specific language governing permissions and limitations</span><br><span class="line"> * under the License.</span><br><span class="line"> *&#x2F;</span><br><span class="line">syntax &#x3D; &quot;proto2&quot;;</span><br><span class="line">option java_package &#x3D; &quot;org.apache.bookkeeper.mledger.proto&quot;;</span><br><span class="line">option optimize_for &#x3D; SPEED;</span><br><span class="line">message KeyValue &#123;</span><br><span class="line">    required string key &#x3D; 1;</span><br><span class="line">    required string value &#x3D; 2;</span><br><span class="line">&#125;</span><br><span class="line">message OffloadDriverMetadata &#123;</span><br><span class="line">    required string name &#x3D; 1;</span><br><span class="line">    repeated KeyValue properties &#x3D; 2;</span><br><span class="line">&#125;</span><br><span class="line">message OffloadContext &#123;</span><br><span class="line">    optional int64 uidMsb &#x3D; 1;</span><br><span class="line">    optional int64 uidLsb &#x3D; 2;</span><br><span class="line">    optional bool complete &#x3D; 3;</span><br><span class="line">    optional bool bookkeeperDeleted &#x3D; 4;</span><br><span class="line">    optional int64 timestamp &#x3D; 5;</span><br><span class="line">    optional OffloadDriverMetadata driverMetadata &#x3D; 6;</span><br><span class="line">    repeated OffloadSegment offloadSegment &#x3D; 7;</span><br><span class="line">&#125;</span><br><span class="line">message OffloadSegment &#123;</span><br><span class="line">    optional int64 uidMsb &#x3D; 1;</span><br><span class="line">    optional int64 uidLsb &#x3D; 2;</span><br><span class="line">    optional bool complete &#x3D; 3;</span><br><span class="line">    optional int64 assignedTimestamp &#x3D; 4; &#x2F;&#x2F;timestamp in millisecond</span><br><span class="line">    optional int64 offloadedTimestamp &#x3D; 5; &#x2F;&#x2F;timestamp in millisecond</span><br><span class="line">    optional int64 endEntryId &#x3D; 6;</span><br><span class="line">    optional OffloadDriverMetadata driverMetadata &#x3D; 7;</span><br><span class="line">&#125;</span><br><span class="line">message ManagedLedgerInfo &#123;</span><br><span class="line">    message LedgerInfo &#123;</span><br><span class="line">        required int64 ledgerId &#x3D; 1;</span><br><span class="line">        optional int64 entries &#x3D; 2;</span><br><span class="line">        optional int64 size &#x3D; 3;</span><br><span class="line">        optional int64 timestamp &#x3D; 4;</span><br><span class="line">        optional OffloadContext offloadContext &#x3D; 5;</span><br><span class="line">    &#125;</span><br><span class="line">  repeated LedgerInfo ledgerInfo &#x3D; 1;</span><br><span class="line">    &#x2F;&#x2F; If present, it signals the managed ledger has been</span><br><span class="line">    &#x2F;&#x2F; terminated and this was the position of the last</span><br><span class="line">    &#x2F;&#x2F; committed entry.</span><br><span class="line">    &#x2F;&#x2F; No more entries can be written.</span><br><span class="line">    optional NestedPositionInfo terminatedPosition &#x3D; 2;</span><br><span class="line">    repeated KeyValue properties &#x3D; 3;</span><br><span class="line">&#125;</span><br><span class="line">message PositionInfo &#123;</span><br><span class="line">    required int64 ledgerId &#x3D; 1;</span><br><span class="line">    required int64 entryId &#x3D; 2;</span><br><span class="line">    repeated MessageRange individualDeletedMessages &#x3D; 3;</span><br><span class="line">    &#x2F;&#x2F; Additional custom properties associated with</span><br><span class="line">    &#x2F;&#x2F; the current cursor position</span><br><span class="line">    repeated LongProperty properties &#x3D; 4;</span><br><span class="line">    &#x2F;&#x2F; Store which index in the batch message has been deleted</span><br><span class="line">    repeated BatchedEntryDeletionIndexInfo batchedEntryDeletionIndexInfo &#x3D; 5;</span><br><span class="line">&#125;</span><br><span class="line">message NestedPositionInfo &#123;</span><br><span class="line">    required int64 ledgerId &#x3D; 1;</span><br><span class="line">    required int64 entryId  &#x3D; 2;</span><br><span class="line">&#125;</span><br><span class="line">message MessageRange &#123;</span><br><span class="line">    required NestedPositionInfo lowerEndpoint &#x3D; 1;</span><br><span class="line">    required NestedPositionInfo upperEndpoint &#x3D; 2;</span><br><span class="line">&#125;</span><br><span class="line">message BatchedEntryDeletionIndexInfo &#123;</span><br><span class="line">    required NestedPositionInfo position &#x3D; 1;</span><br><span class="line">    repeated int64 deleteSet &#x3D; 2;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; Generic string and long tuple</span><br><span class="line">message LongProperty &#123;</span><br><span class="line">    required string name &#x3D; 1;</span><br><span class="line">    required int64 value  &#x3D; 2;</span><br><span class="line">&#125;</span><br><span class="line">message ManagedCursorInfo &#123;</span><br><span class="line">    &#x2F;&#x2F; If the ledger id is -1, then the mark-delete position is</span><br><span class="line">    &#x2F;&#x2F; the one from the (ledgerId, entryId) snapshot below</span><br><span class="line">    required int64 cursorsLedgerId &#x3D; 1;</span><br><span class="line">    &#x2F;&#x2F; Last snapshot of the mark-delete position</span><br><span class="line">    optional int64 markDeleteLedgerId &#x3D; 2;</span><br><span class="line">    optional int64 markDeleteEntryId &#x3D; 3;</span><br><span class="line">    repeated MessageRange individualDeletedMessages &#x3D; 4;</span><br><span class="line">    &#x2F;&#x2F; Additional custom properties associated with</span><br><span class="line">    &#x2F;&#x2F; the current cursor position</span><br><span class="line">    repeated LongProperty properties &#x3D; 5;</span><br><span class="line">    optional int64 lastActive &#x3D; 6;</span><br><span class="line">    &#x2F;&#x2F; Store which index in the batch message has been deleted</span><br><span class="line">    repeated BatchedEntryDeletionIndexInfo batchedEntryDeletionIndexInfo &#x3D; 7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-判断topic是属于哪一个broker"><a href="#2-3-判断topic是属于哪一个broker" class="headerlink" title="2.3 判断topic是属于哪一个broker"></a>2.3 判断topic是属于哪一个broker</h2><p>通过topic查找bundle，然后判断bundle是否属于broker。</p>
<p>OwnershipCache中的ownershipReadOnlyCache：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">private CompletableFuture&lt;Optional&lt;Map.Entry&lt;NamespaceEphemeralData, Stat&gt;&gt;&gt; resolveOwnership(String path) &#123;</span><br><span class="line">    &#x2F;&#x2F; 通过缓存的zk信息，找到该path(topic全路径)对应的的bundle信息</span><br><span class="line">    return ownershipReadOnlyCache.getWithStatAsync(path).thenApply(optionalOwnerDataWithStat -&gt; &#123;</span><br><span class="line">        if (optionalOwnerDataWithStat.isPresent()) &#123;</span><br><span class="line">            Map.Entry&lt;NamespaceEphemeralData, Stat&gt; ownerDataWithStat &#x3D; optionalOwnerDataWithStat.get();</span><br><span class="line">            Stat stat &#x3D; ownerDataWithStat.getValue();</span><br><span class="line">            if (stat.getEphemeralOwner() &#x3D;&#x3D; localZkCache.getZooKeeper().getSessionId()) &#123;</span><br><span class="line">                LOG.info(&quot;Successfully reestablish ownership of &#123;&#125;&quot;, path);</span><br><span class="line">                OwnedBundle ownedBundle &#x3D; new OwnedBundle(ServiceUnitUtils.suBundleFromPath(path, bundleFactory));</span><br><span class="line">                if (selfOwnerInfo.getNativeUrl().equals(ownerDataWithStat.getKey().getNativeUrl())) &#123;</span><br><span class="line">                    ownedBundlesCache.put(path, CompletableFuture.completedFuture(ownedBundle));</span><br><span class="line">                &#125;</span><br><span class="line">                ownershipReadOnlyCache.invalidate(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return optionalOwnerDataWithStat;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h1><ul>
<li>consumer可以随机连上一个broker，通过发送lookup命令可以最终找到一个处理所需topic的broker地址，然后连接到该broker。</li>
<li>broker接收到consumer连接后，建立好topic - subscription - dispatcher - consumer的关系，同时打开ledger和cursor，准备消息的读写。</li>
<li>consumer建立好连接后，不定时的发送flow命令，通知broker可以发送更多的消息了，broker接收到命令后，通过ledger读取消息并异步发送给consumer。</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">iMine</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://imine141.github.io/2021/08/09/pulsar/pulsar%E6%B6%88%E6%81%AF%E8%AF%BB%E6%B5%81%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/">https://imine141.github.io/2021/08/09/pulsar/pulsar%E6%B6%88%E6%81%AF%E8%AF%BB%E6%B5%81%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pulsar/">pulsar</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/08/10/pulsar/pulsar%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"><i class="fa fa-chevron-left">  </i><span>pulsar负载均衡</span></a></div><div class="next-post pull-right"><a href="/2021/08/06/pulsar/pulsar%E5%AF%B9%E6%B6%88%E6%81%AF%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86/"><span>pulsar对消息进行加密</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '316d899c68e414a53017',
  clientSecret: 'e63edfd4dd96b3b665a0a561e2ce048c2b3f0a3b',
  repo: 'imine141.github.io',
  owner: 'imine141',
  admin: 'imine141',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2024 By iMine</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>